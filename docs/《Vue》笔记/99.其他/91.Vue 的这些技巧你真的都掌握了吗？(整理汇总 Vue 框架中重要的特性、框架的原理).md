---
title: Vue çš„è¿™äº›æŠ€å·§ä½ çœŸçš„éƒ½æŒæ¡äº†å—ï¼Ÿ(æ•´ç†æ±‡æ€» Vue æ¡†æ¶ä¸­é‡è¦çš„ç‰¹æ€§ã€æ¡†æ¶çš„åŸç†)
date: 2021-12-31 16:07:51
permalink: /pages/961fa6/
categories:
  - ã€ŠVueã€‹ç¬”è®°
  - å…¶ä»–
tags:
  - 
---


![banner](https://edu-guli-oss1.oss-cn-beijing.aliyuncs.com/blog/640.webp)

# å‰è¨€

æ–‡ç« ç›®çš„æ˜­ç„¶è‹¥æ­ğŸ±â€ğŸ‰ï¼Œæ•´ç†æ±‡æ€» Vue æ¡†æ¶ä¸­é‡è¦çš„ç‰¹æ€§ã€æ¡†æ¶çš„åŸç†ã€‚

é‚£ "å‰è½¦ä¹‹é‰´" ä»ä½•è€Œæ¥ï¼Ÿ

æ˜¯çš„ï¼Œæˆ‘åˆè¦è®²å°æ•…äº‹äº†ï¼Œä½†è¿™æ¬¡æ˜¯æ•…äº‹çš„ç»­é›†ã€‚

æ•…äº‹ç¬¬ 1 é›†ï¼šCSSé¢„å¤„ç†å™¨ï¼Œä½ è¿˜æ˜¯åªä¼šåµŒå¥—ä¹ˆ ï¼Ÿ[2]
æ•…äº‹ç¬¬ 2 é›†ï¼šã€è‡ªé€‚åº”ã€‘px è½¬ remï¼Œä½ è¿˜åœ¨æ‰‹ç®—ä¹ˆï¼Ÿ[3]

ä¸ºä»€ä¹ˆè¯´æ˜¯ç»­é›†ï¼Œå› ä¸ºè¿™äº›éƒ½æ˜¯åŒä¸€å¤§ä½¬é—®çš„ï¼Œåœ¨æ­¤æ„Ÿè°¢å¤§ä½¬ï¼Œå¤©é™ç´ æğŸ¤£ã€‚

æ•…äº‹ç»­é›†

å¤§ä½¬ï¼šæœ‰çœ‹è¿‡ Vue æºç ä¹ˆï¼Ÿ

æˆ‘ï¼šå—¯å—¯ï¼Œçœ‹è¿‡ã€‚

å¤§ä½¬ï¼šé‚£å¤§æ¦‚è®²ä¸€è®² nextTick çš„åº•å±‚å®ç° ï¼Ÿ

æˆ‘ï¼šåœé¡¿äº†å¤§æ¦‚10sï¼Œè¯´äº†å¥å¿˜äº†ã€‚ï¼ˆç†ä¸ç›´æ°”è¿˜å£®ï¼‰

å¤§ä½¬ï¼šå™¢å™¢ï¼Œæ²¡äº‹ã€‚ï¼ˆå†…å¿ƒå¤§æ¦‚å·²ç»æ”¾å¼ƒå¯¹æˆ‘çŸ¥è¯†é¢çš„æŒ–æ˜ï¼‰

å› ä¸ºæ˜¯è§†é¢‘é¢è¯•ï¼Œå¼ºè£…è‡ªä¿¡çš„å°´å°¬ä»å±å¹•ä¸­æº¢å‡ºï¼Œè¿™å¤§æ¦‚å°±æ˜¯æ™®é€šä¸”è‡ªä¿¡ğŸ¤¦â€â™‚ï¸ï¼Ÿè£…Xå¤±è´¥æ¡ˆä¾‹å¼•ä»¥ä¸ºæˆ’ï¼Œèƒ½å†™å‡ºç»­é›†çš„é¢è¯•ç»“æœä¸æä¹Ÿç½¢ã€‚

è¿™æ¬¡é¢è¯•æ‰“å‡»è¿˜æ˜¯è›®å¤§çš„ï¼Œè€ƒå¯Ÿå†…å®¹å…¨é¢ä¸”ç»†èŠ‚ã€‚é¢è¯•åä¸€ç›´åœ¨æ•´ç† Vue ç›¸å…³çš„çŸ¥è¯†ç‚¹ï¼Œæ‰€ä»¥ä¸ä¼šå°†nextTickå®ç°å•ç‹¬æˆæ–‡ï¼Œåªæ˜¯æ”¶å½•åœ¨ä¸‹æ–¹è¯•é¢˜ä¸­ã€‚å‰è½¦ä¹‹é‰´å¯ä»¥ä¸ºé‰´ï¼Œå¤§å®¶å¯ä»¥æŠŠæœ¬ç¯‡æ–‡ç« å½“æµ‹éªŒï¼Œè€ƒå¯Ÿè‡ªå·±æ˜¯å¦å¯¹è¿™äº›çŸ¥è¯†ç‚¹ç†Ÿç»ƒäºå¿ƒã€‚

ä¸‡å­—é•¿æ–‡ï¼ŒæŒç»­æ›´æ–°ï¼Œè‹¥æœ‰é—æ¼çŸ¥è¯†ç‚¹ï¼Œåç»­ä¼šè¡¥å……ã€‚


# é¢˜ç›®

## ä¼˜ç‚¹
1.åˆ›å»ºå•é¡µé¢åº”ç”¨çš„è½»é‡çº§Webåº”ç”¨æ¡†æ¶
2.ç®€å•æ˜“ç”¨
3.åŒå‘æ•°æ®ç»‘å®š
4.ç»„ä»¶åŒ–çš„æ€æƒ³
5.è™šæ‹ŸDOM
6.æ•°æ®é©±åŠ¨è§†å›¾

## ç¼ºç‚¹
ä¸æ”¯æŒIE8ï¼ˆç°é˜¶æ®µåªèƒ½å‹‰å¼ºå‡‘å‡ºè¿™ä¹ˆåŠç‚¹ğŸ˜‚ï¼‰

# SPA çš„ç†è§£

SPAæ˜¯Single-Page-Applicationçš„ç¼©å†™ï¼Œç¿»è¯‘è¿‡æ¥å°±æ˜¯å•é¡µåº”ç”¨ã€‚åœ¨WEBé¡µé¢åˆå§‹åŒ–æ—¶ä¸€åŒåŠ è½½Htmlã€Javascriptã€Cssã€‚ä¸€æ—¦é¡µé¢åŠ è½½å®Œæˆï¼ŒSPAä¸ä¼šå› ä¸ºç”¨æˆ·æ“ä½œè€Œè¿›è¡Œé¡µé¢é‡æ–°åŠ è½½æˆ–è·³è½¬ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯åˆ©ç”¨è·¯ç”±æœºåˆ¶å®ç°Htmlå†…å®¹çš„å˜æ¢ã€‚

##ä¼˜ç‚¹
1.è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œå†…å®¹æ›´æ”¹æ— éœ€é‡è½½é¡µé¢ã€‚
2.åŸºäºä¸Šé¢ä¸€ç‚¹ï¼ŒSPAç›¸å¯¹æœåŠ¡ç«¯å‹åŠ›æ›´å°ã€‚
3.å‰åç«¯èŒè´£åˆ†ç¦»ï¼Œæ¶æ„æ¸…æ™°ã€‚

## ç¼ºç‚¹
1.ç”±äºå•é¡µWEBåº”ç”¨ï¼Œéœ€åœ¨åŠ è½½æ¸²æŸ“é¡µé¢æ—¶è¯·æ±‚JavaScriptã€Cssæ–‡ä»¶ï¼Œæ‰€ä»¥è€—æ—¶æ›´å¤šã€‚
2.ç”±äºå‰ç«¯æ¸²æŸ“ï¼Œæœç´¢å¼•æ“ä¸ä¼šè§£æJSï¼Œåªèƒ½æŠ“å–é¦–é¡µæœªæ¸²æŸ“çš„æ¨¡æ¿ï¼Œä¸åˆ©äºSEOã€‚
3.ç”±äºå•é¡µåº”ç”¨éœ€åœ¨ä¸€ä¸ªé¡µé¢æ˜¾ç¤ºæ‰€æœ‰çš„å†…å®¹ï¼Œé»˜è®¤ä¸æ”¯æŒæµè§ˆå™¨çš„å‰è¿›åé€€ã€‚

ç¼ºç‚¹3ï¼Œæƒ³å¿…æœ‰äººå’Œæˆ‘æœ‰åŒæ ·çš„ç–‘é—®ã€‚

é€šè¿‡èµ„æ–™æŸ¥é˜…ï¼Œå…¶å®æ˜¯å‰ç«¯è·¯ç”±æœºåˆ¶è§£å†³äº†å•é¡µåº”ç”¨æ— æ³•å‰è¿›åé€€çš„é—®é¢˜ã€‚Hashæ¨¡å¼ä¸­Hashå˜åŒ–ä¼šè¢«æµè§ˆå™¨è®°å½•ï¼ˆonhashchangeäº‹ä»¶ï¼‰ï¼ŒHistoryæ¨¡å¼åˆ©ç”¨ H5 æ–°å¢çš„pushStateå’ŒreplaceStateæ–¹æ³•å¯æ”¹å˜æµè§ˆå™¨å†å²è®°å½•æ ˆã€‚


# new Vue(options) éƒ½åšäº†äº›ä»€ä¹ˆ

å¦‚ä¸‹ Vue æ„é€ å‡½æ•°æ‰€ç¤ºï¼Œä¸»è¦æ‰§è¡Œäº† this._init(options)æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åœ¨initMixinå‡½æ•°ä¸­æ³¨å†Œã€‚

```javascript
import { initMixin } from './init'
import { stateMixin } from './state'
import { renderMixin } from './render'
import { eventsMixin } from './events'
import { lifecycleMixin } from './lifecycle'
import { warn } from '../util/index'

function Vue (options) {
  if (process.env.NODE_ENV !== 'production' &&
    !(this instanceof Vue)
  ) {
    warn('Vue is a constructor and should be called with the `new` keyword')
  }
  // Vue.prototype._init æ–¹æ³•
  this._init(options)
}

// _init æ–¹æ³•åœ¨ initMixin æ³¨å†Œ
initMixin(Vue)
stateMixin(Vue)
eventsMixin(Vue)
lifecycleMixin(Vue)
renderMixin(Vue)

export default Vue
```

æŸ¥çœ‹initMixinæ–¹æ³•çš„å®ç°ï¼Œå…¶ä»–å‡½æ•°å…·ä½“å®ç°å¯è‡ªè¡ŒæŸ¥çœ‹ï¼Œè¿™é‡Œå°±ä¸è´´å‡ºäº†ã€‚

```javascript
let uid = 0
export function initMixin() {
  Vue.prototype._init = function(options) {
    const vm = this
    vm._uid = uid++
    vm._isVue = true
   
    // å¤„ç†ç»„ä»¶é…ç½®é¡¹
    if (options && options._isComponent) {
       /**
       * å¦‚æœæ˜¯å­ç»„ä»¶ï¼Œèµ°å½“å‰ if åˆ†æ”¯
       * å‡½æ•°ä½œç”¨æ˜¯æ€§èƒ½ä¼˜åŒ–ï¼šå°†åŸå‹é“¾ä¸Šçš„æ–¹æ³•éƒ½æ”¾åˆ°vm.$optionsä¸­ï¼Œå‡å°‘åŸå‹é“¾ä¸Šçš„è®¿é—®
       */   
      initInternalComponent(vm, options)
    } else {
      /**
       * å¦‚æœæ˜¯æ ¹ç»„ä»¶ï¼Œèµ°å½“å‰ else åˆ†æ”¯
       * åˆå¹¶ Vue çš„å…¨å±€é…ç½®åˆ°æ ¹ç»„ä»¶ä¸­ï¼Œå¦‚ Vue.component æ³¨å†Œçš„å…¨å±€ç»„ä»¶åˆå¹¶åˆ°æ ¹ç»„ä»¶çš„ components çš„é€‰é¡¹ä¸­
       * å­ç»„ä»¶çš„é€‰é¡¹åˆå¹¶å‘ç”Ÿåœ¨ä¸¤ä¸ªåœ°æ–¹
       * 1. Vue.component æ–¹æ³•æ³¨å†Œçš„å…¨å±€ç»„ä»¶åœ¨æ³¨å†Œæ—¶åšäº†é€‰é¡¹åˆå¹¶
       * 2. { component: {xx} } æ–¹æ³•æ³¨å†Œçš„å±€éƒ¨ç»„ä»¶åœ¨æ‰§è¡Œç¼–è¯‘å™¨ç”Ÿæˆçš„ render å‡½æ•°æ—¶åšäº†é€‰é¡¹åˆå¹¶
       */  
      vm.$options = mergeOptions(
        resolveConstructorOptions(vm.constructor),
        options || {},
        vm
      )
    }
  
    if (process.env.NODE_ENV !== 'production') {
      initProxy(vm)
    } else {
      vm._renderProxy = vm
    }

    vm._self = vm
    /**
    * åˆå§‹åŒ–ç»„ä»¶å®ä¾‹å…³ç³»å±æ€§ï¼Œå¦‚ï¼š$parent $root $children $refs
    */
    initLifecycle(vm)
    /**
    * åˆå§‹åŒ–è‡ªå®šä¹‰äº‹ä»¶
    * <component @click="handleClick"></component>
    * ç»„ä»¶ä¸Šæ³¨å†Œçš„äº‹ä»¶ï¼Œç›‘å¬è€…ä¸æ˜¯çˆ¶ç»„ä»¶ï¼Œè€Œæ˜¯å­ç»„ä»¶æœ¬èº«
    */
    initEvents(vm)
    /**
    * è§£æç»„ä»¶æ’æ§½ä¿¡æ¯ï¼Œå¾—åˆ°vm.$slotï¼Œå¤„ç†æ¸²æŸ“å‡½æ•°ï¼Œå¾—åˆ° vm.$createElement æ–¹æ³•ï¼Œå³ h å‡½æ•°ã€‚
    */
    initRender(vm)
    /**
    * æ‰§è¡Œ beforeCreate ç”Ÿå‘½å‘¨æœŸå‡½æ•°
    */
    callHook(vm, 'beforeCreate')
    /**
    * è§£æ inject é…ç½®é¡¹ï¼Œå¾—åˆ° result[key] = val çš„é…ç½®å¯¹è±¡ï¼Œåšå“åº”å¼å¤„ç†ä¸”ä»£ç†åˆ° vm å®åŠ›ä¸Š
    */
    initInjections(vm) 
    /**
    * å“åº”å¼å¤„ç†æ ¸å¿ƒï¼Œå¤„ç† propsã€methodsã€dataã€computedã€watch
    */
    initState(vm)
    /**
    * è§£æ provide å¯¹è±¡ï¼Œå¹¶æŒ‚è½½åˆ° vm å®ä¾‹ä¸Š
    */
    initProvide(vm) 
    /**
    * æ‰§è¡Œ created ç”Ÿå‘½å‘¨æœŸå‡½æ•°
    */
    callHook(vm, 'created')

    // å¦‚æœ el é€‰é¡¹ï¼Œè‡ªåŠ¨æ‰§è¡Œ$mount
    if (vm.$options.el) {
      vm.$mount(vm.$options.el)
    }
  }
}
```

#MVVM çš„ç†è§£

MVVMæ˜¯Model-View-ViewModelçš„ç¼©å†™ã€‚Model ä»£è¡¨æ•°æ®å±‚ï¼Œå¯å®šä¹‰ä¿®æ”¹æ•°æ®ã€ç¼–å†™ä¸šåŠ¡é€»è¾‘ã€‚View ä»£è¡¨è§†å›¾å±‚ï¼Œè´Ÿè´£å°†æ•°æ®æ¸²æŸ“æˆé¡µé¢ã€‚ViewModel è´Ÿè´£ç›‘å¬æ•°æ®å±‚æ•°æ®å˜åŒ–ï¼Œæ§åˆ¶è§†å›¾å±‚è¡Œä¸ºäº¤äº’ï¼Œç®€å•è®²ï¼Œå°±æ˜¯åŒæ­¥æ•°æ®å±‚å’Œè§†å›¾å±‚çš„å¯¹è±¡ã€‚ViewModel é€šè¿‡åŒå‘ç»‘å®šæŠŠ View å’Œ Model å±‚è¿æ¥èµ·æ¥ï¼Œä¸”åŒæ­¥å·¥ä½œæ— éœ€äººä¸ºå¹²æ¶‰ï¼Œä½¿å¼€å‘äººå‘˜åªå…³æ³¨ä¸šåŠ¡é€»è¾‘ï¼Œæ— éœ€é¢‘ç¹æ“ä½œDOMï¼Œä¸éœ€å…³æ³¨æ•°æ®çŠ¶æ€çš„åŒæ­¥é—®é¢˜ã€‚

## å¦‚ä½•å®ç° v-model

v-modelæŒ‡ä»¤ç”¨äºå®ç°inputã€selectç­‰è¡¨å•å…ƒç´ çš„åŒå‘ç»‘å®šï¼Œæ˜¯ä¸ªè¯­æ³•ç³–ã€‚

åŸç”Ÿ input å…ƒç´ è‹¥æ˜¯text/textareaç±»å‹ï¼Œä½¿ç”¨ value å±æ€§å’Œ input äº‹ä»¶ã€‚
åŸç”Ÿ input å…ƒç´ è‹¥æ˜¯radio/checkboxç±»å‹ï¼Œä½¿ç”¨ checkedå±æ€§å’Œ change äº‹ä»¶ã€‚
åŸç”Ÿ select å…ƒç´ ï¼Œä½¿ç”¨ value å±æ€§å’Œ change äº‹ä»¶ã€‚

input å…ƒç´ ä¸Šä½¿ç”¨ v-model ç­‰ä»·äº

```vue
<input :value="message" @input="message = $event.target.value" />
```

## å®ç°è‡ªå®šä¹‰ç»„ä»¶çš„ v-model

è‡ªå®šä¹‰ç»„ä»¶çš„v-modelä½¿ç”¨propå€¼ä¸ºvalueå’Œinputäº‹ä»¶ã€‚è‹¥æ˜¯radio/checkboxç±»å‹ï¼Œéœ€è¦ä½¿ç”¨modelæ¥è§£å†³åŸç”Ÿ DOM ä½¿ç”¨çš„æ˜¯ checked å±æ€§ å’Œ change äº‹ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

```vue
// çˆ¶ç»„ä»¶
<template>
  <base-checkbox v-model="baseCheck" />
</template>
```

```vue
// å­ç»„ä»¶
<template>
  <input type="checkbox" :checked="checked" @change="$emit('change', $event.target.checked)" />
</template>
<script>
export default {
  model: {
    prop: 'checked',
    event: 'change'
  },
  prop: {
    checked: Boolean
  }
}
</script>
```

# å¦‚ä½•ç†è§£ Vue å•å‘æ•°æ®æµ

æˆ‘ä»¬ç»å¸¸è¯´ Vue çš„åŒå‘ç»‘å®šï¼Œå…¶å®æ˜¯åœ¨å•å‘ç»‘å®šçš„åŸºç¡€ä¸Šç»™å…ƒç´ æ·»åŠ  input/change äº‹ä»¶ï¼Œæ¥åŠ¨æ€ä¿®æ”¹è§†å›¾ã€‚Vue ç»„ä»¶é—´ä¼ é€’æ•°æ®ä»ç„¶æ˜¯å•é¡¹çš„ï¼Œå³çˆ¶ç»„ä»¶ä¼ é€’åˆ°å­ç»„ä»¶ã€‚å­ç»„ä»¶å†…éƒ¨å¯ä»¥å®šä¹‰ä¾èµ– props ä¸­çš„å€¼ï¼Œä½†æ— æƒä¿®æ”¹çˆ¶ç»„ä»¶ä¼ é€’çš„æ•°æ®ï¼Œè¿™æ ·åšé˜²æ­¢å­ç»„ä»¶æ„å¤–å˜æ›´çˆ¶ç»„ä»¶çš„çŠ¶æ€ï¼Œå¯¼è‡´åº”ç”¨æ•°æ®æµå‘éš¾ä»¥ç†è§£ã€‚

å¦‚æœåœ¨å­ç»„ä»¶å†…éƒ¨ç›´æ¥æ›´æ”¹propï¼Œä¼šé‡åˆ°è­¦å‘Šå¤„ç†ã€‚

2 ç§å®šä¹‰ä¾èµ– props ä¸­çš„å€¼

1.é€šè¿‡ data å®šä¹‰å±æ€§å¹¶å°† prop ä½œä¸ºåˆå§‹å€¼ã€‚

```javascript
<script>
export default {
  props: ['initialNumber'],
  data() {
    return {
      number: this.initailNumber
    }
  }
}
</script>
```

2.ç”¨ computed è®¡ç®—å±æ€§å»å®šä¹‰ä¾èµ– prop çš„å€¼ã€‚è‹¥é¡µé¢ä¼šæ›´æ”¹å½“å‰å€¼ï¼Œå¾—åˆ† get

```javascript
<script>
export default {
  props: ['size'],
  computed: {
    normalizedSize() {
      return this.size.trim().toLowerCase()
    }
  }
}
</sciprt>
```

# Vue å“åº”å¼åŸç†


æ ¸å¿ƒæºç ä½ç½®ï¼švue/src/core/observer/index.js

å“åº”å¼åŸç†3ä¸ªæ­¥éª¤ï¼šæ•°æ®åŠ«æŒã€ä¾èµ–æ”¶é›†ã€æ´¾å‘æ›´æ–°ã€‚

æ•°æ®åˆ†ä¸ºä¸¤ç±»ï¼šå¯¹è±¡ã€æ•°ç»„ã€‚

## å¯¹è±¡

éå†å¯¹è±¡ï¼Œé€šè¿‡Object.definePropertyä¸ºæ¯ä¸ªå±æ€§æ·»åŠ  getter å’Œ setterï¼Œè¿›è¡Œæ•°æ®åŠ«æŒã€‚getter å‡½æ•°ç”¨äºåœ¨æ•°æ®è¯»å–æ—¶è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œåœ¨å¯¹åº”çš„ dep ä¸­å­˜å‚¨æ‰€æœ‰çš„ watcherï¼›setter åˆ™æ˜¯æ•°æ®æ›´æ–°åé€šçŸ¥æ‰€æœ‰çš„ watcher è¿›è¡Œæ›´æ–°ã€‚

æ ¸å¿ƒæºç 

```javascript
function defineReactive(obj, key, val, shallow) {
  // å®ä¾‹åŒ–ä¸€ä¸ª depï¼Œ ä¸€ä¸ª key å¯¹åº”ä¸€ä¸ª dep
  const dep = new Dep()
 
  // è·å–å±æ€§æè¿°ç¬¦
  const getter = property && property.get
  const setter = property && property.set
  if ((!getter || setter) && arguments.length === 2) {
    val = obj[key]
  }

  // é€šè¿‡é€’å½’çš„æ–¹å¼å¤„ç† val ä¸ºå¯¹è±¡çš„æƒ…å†µï¼Œå³å¤„ç†åµŒå¥—å¯¹è±¡
  let childOb = !shallow && observe(val)
  
  Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    // æ‹¦æˆªobj.keyï¼Œè¿›è¡Œä¾èµ–æ”¶é›†
    get: function reactiveGetter () {
      const value = getter ? getter.call(obj) : val
      // Dep.target æ˜¯å½“å‰ç»„ä»¶æ¸²æŸ“çš„ watcher
      if (Dep.target) {
        // å°† dep æ·»åŠ åˆ° watcher ä¸­
        dep.depend()
        if (childOb) {
          // åµŒå¥—å¯¹è±¡ä¾èµ–æ”¶é›†
          childOb.dep.depend()
          // å“åº”å¼å¤„ç† value å€¼ä¸ºæ•°ç»„çš„æƒ…å†µ
          if (Array.isArray(value)) {
            dependArray(value)
          }
        }
      }
      return value
    },
    set: function reactiveSetter (newVal) {
      // è·å–æ—§å€¼
      const value = getter ? getter.call(obj) : val
      // åˆ¤æ–­æ–°æ—§å€¼æ˜¯å¦ä¸€è‡´
      if (newVal === value || (newVal !== newVal && value !== value)) {
        return
      }
      if (process.env.NODE_ENV !== 'production' && customSetter) {
        customSetter()
      }

      if (getter && !setter) return
      // å¦‚æœæ˜¯æ–°å€¼ï¼Œç”¨æ–°å€¼æ›¿æ¢æ—§å€¼
      if (setter) {
        setter.call(obj, newVal)
      } else {
        val = newVal
      }
      // æ–°å€¼åšå“åº”å¼å¤„ç†
      childOb = !shallow && observe(newVal)
      // å½“å“åº”å¼æ•°æ®æ›´æ–°ï¼Œä¾èµ–é€šçŸ¥æ›´æ–°
      dep.notify()
    }
  })
}
```

## æ‰‹å†™è§‚å¯Ÿè€…æ¨¡å¼

å½“å¯¹è±¡é—´å­˜åœ¨ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼ã€‚æ¯”å¦‚ï¼šå½“ä¸€ä¸ªå¯¹è±¡è¢«ä¿®æ”¹ï¼Œä¼šè‡ªåŠ¨é€šçŸ¥ä¾èµ–å®ƒçš„å¯¹è±¡ã€‚

```javascript
let uid = 0
class Dep {
  constructor() {
    this.id = uid++
    // å­˜å‚¨æ‰€æœ‰çš„ watcher
    this.subs = []
  }
  addSub(sub) {
    this.subs.push(sub)
  }
  removeSub(sub) {
    if(this.subs.length) {
      const index = this.subs.indexOf(sub)
      if(index > -1) return this.subs.splice(index, 1)
    }
  }
  notify() {
    this.subs.forEach(sub => {
      sub.update()
    })
  }
}

class Watcher {
  constructor(name) {
    this.name = name
  }
  update() {
    console.log('æ›´æ–°')
  }
}
```

# æ‰‹å†™å‘å¸ƒè®¢é˜…æ¨¡å¼

ä¸è§‚å¯Ÿè€…æ¨¡å¼ç›¸ä¼¼ï¼ŒåŒºåˆ«åœ¨äºå‘å¸ƒè€…å’Œè®¢é˜…è€…æ˜¯è§£è€¦çš„ï¼Œç”±ä¸­é—´çš„è°ƒåº¦ä¸­å¿ƒå»ä¸å‘å¸ƒè€…å’Œè®¢é˜…è€…é€šä¿¡ã€‚

Vueå“åº”å¼åŸç†ä¸ªäººæ›´å€¾å‘äºå‘å¸ƒè®¢é˜…æ¨¡å¼ã€‚å…¶ä¸­ Observer æ˜¯å‘å¸ƒè€…ï¼ŒWatcher æ˜¯è®¢é˜…è€…ï¼ŒDep æ˜¯è°ƒåº¦ä¸­å¿ƒã€‚

```javascript
class EventEmitter {
  constructor() {
    this.events = {}
  }
  on(type, cb) {
    if(!this.events[type]) this.events[type] = []
    this.events[type].push(cb)
  }
  emit(type, ...args) {
    if(this.events[type]) {
      this.events[type].forEach(cb => {
        cb(...args)
      })
    }
  }
  off(type, cb) {
    if(this.events[type]) {
      const index = this.events[type].indexOf(cb)
      if(index > -1) this.events[type].splice(index, 1)
    }
  }
}
```

# å…³äº Vue.observable çš„äº†è§£

Vue.observable å¯ä½¿å¯¹è±¡å¯å“åº”ã€‚è¿”å›çš„å¯¹è±¡å¯ç›´æ¥ç”¨äºæ¸²æŸ“å‡½æ•°å’Œè®¡ç®—å±æ€§å†…ï¼Œå¹¶ä¸”åœ¨å‘ç”Ÿå˜æ›´æ—¶è§¦å‘ç›¸åº”çš„æ›´æ–°ã€‚ä¹Ÿå¯ä»¥ä½œä¸ºæœ€å°åŒ–çš„è·¨ç»„ä»¶çŠ¶æ€å­˜å‚¨å™¨ã€‚

Vue 2.x ä¸­ä¼ å…¥çš„å¯¹è±¡å’Œè¿”å›çš„å¯¹è±¡æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚
Vue 3.x åˆ™ä¸æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæºå¯¹è±¡ä¸å…·å¤‡å“åº”å¼åŠŸèƒ½ã€‚

é€‚ç”¨çš„åœºæ™¯ï¼šåœ¨é¡¹ç›®ä¸­æ²¡æœ‰å¤§é‡çš„éçˆ¶å­ç»„ä»¶é€šä¿¡æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ Vue.observable å»æ›¿ä»£ eventBuså’Œvuexæ–¹æ¡ˆã€‚

ç”¨æ³•å¦‚ä¸‹

```vue
// store.js
import Vue from 'vue'
export const state = Vue.observable({
  count: 1
})
export const mutations = {
  setCount(count) {
    state.count = count
  }
} 

// vue æ–‡ä»¶
<template>
  <div>{{ count }}</div>
</template>
<script>
import { state, mutation } from './store.js'
export default {
  computed: {
    count() {
      return state.count
    }
  }
}
</script>
```

åŸç†éƒ¨åˆ†å’Œå“åº”å¼åŸç†å¤„ç†ç»„ä»¶ data æ˜¯åŒä¸€ä¸ªå‡½æ•°ï¼Œå®ä¾‹åŒ–ä¸€ä¸ª Observeï¼Œå¯¹æ•°æ®åŠ«æŒã€‚

#   ç»„ä»¶ä¸­çš„ data ä¸ºä»€ä¹ˆæ˜¯ä¸ªå‡½æ•°

å¯¹è±¡åœ¨æ ˆä¸­å­˜å‚¨çš„éƒ½æ˜¯åœ°å€ï¼Œå‡½æ•°çš„ä½œç”¨å°±æ˜¯å±æ€§ç§æœ‰åŒ–ï¼Œä¿è¯ç»„ä»¶ä¿®æ”¹è‡ªèº«å±æ€§æ—¶ä¸ä¼šå½±å“å…¶ä»–å¤ç”¨ç»„ä»¶ã€‚


# Vue çˆ¶ç»„ä»¶å’Œå­ç»„ä»¶ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œé¡ºåº

## åŠ è½½æ¸²æŸ“è¿‡ç¨‹

çˆ¶å…ˆåˆ›å»ºï¼Œæ‰èƒ½æœ‰å­ï¼›å­åˆ›å»ºå®Œæˆï¼Œçˆ¶æ‰å®Œæ•´ã€‚

é¡ºåºï¼šçˆ¶ beforeCreate -> çˆ¶ created -> çˆ¶ beforeMount -> å­ beforeCreate -> å­ created -> å­ beforeMount -> å­ mounted -> çˆ¶ mounted

## å­ç»„ä»¶æ›´æ–°è¿‡ç¨‹

1.å­ç»„ä»¶æ›´æ–° å½±å“åˆ° çˆ¶ç»„ä»¶çš„æƒ…å†µã€‚

é¡ºåºï¼šçˆ¶ beforeUpdate -> å­ beforeUpdate -> å­ updated -> çˆ¶ updated

2.å­ç»„ä»¶æ›´æ–° ä¸å½±å“åˆ° çˆ¶ç»„ä»¶çš„æƒ…å†µã€‚

é¡ºåºï¼šå­ beforeUpdate -> å­ updated

## çˆ¶ç»„ä»¶æ›´æ–°è¿‡ç¨‹
çˆ¶ç»„ä»¶æ›´æ–° å½±å“åˆ° å­ç»„ä»¶çš„æƒ…å†µã€‚

1.çˆ¶ç»„ä»¶æ›´æ–° å½±å“åˆ° å­ç»„ä»¶çš„æƒ…å†µã€‚

é¡ºåºï¼šçˆ¶ beforeUpdate -> å­ beforeUpdate -> å­ updated -> çˆ¶ updated

2.çˆ¶ç»„ä»¶æ›´æ–° ä¸å½±å“åˆ° å­ç»„ä»¶çš„æƒ…å†µã€‚

é¡ºåºï¼šçˆ¶ beforeUpdate -> çˆ¶ updated

é”€æ¯è¿‡ç¨‹

é¡ºåºï¼šçˆ¶ beforeDestroy -> å­ beforeDestroy -> å­ destroyed -> çˆ¶ destroyed 

# çˆ¶ç»„ä»¶å¦‚ä½•ç›‘å¬å­ç»„ä»¶ç”Ÿå‘½å‘¨æœŸçš„é’©å­å‡½æ•°

ä¸¤ç§æ–¹å¼éƒ½ä»¥ mounted ä¸ºä¾‹å­ã€‚

## $emitå®ç°

```vue
// çˆ¶ç»„ä»¶
<template>
  <div class="parent">
    <Child @mounted="doSomething"/>
  </div>
</template>
<script>
export default {  
  methods: {
    doSomething() {
      console.log('çˆ¶ç»„ä»¶ç›‘å¬åˆ°å­ç»„ä»¶ mounted é’©å­å‡½æ•°')
    }
  }
}
</script>
//å­ç»„ä»¶
<template>
  <div class="child">
  </div>
</template>
<script>
export default {
  mounted() {
    console.log('è§¦å‘mountedäº‹ä»¶...')
    this.$emit("mounted")
  }
}
</script>
```


## @hookå®ç°

```vue
// çˆ¶ç»„ä»¶
<template>
  <div class="parent">
    <Child @hook:mounted="doSomething"/>
  </div>
</template>
<script>
export default {  
  methods: {
    doSomething() {
      console.log('çˆ¶ç»„ä»¶ç›‘å¬åˆ°å­ç»„ä»¶ mounted é’©å­å‡½æ•°')
    }
  }
}
</script>

//å­ç»„ä»¶
<template>
  <div class="child">
  </div>
</template>
<script>
export default {
  mounted() {
    console.log('è§¦å‘mountedäº‹ä»¶...')
  }
}
</script>
```

# Vue ç»„ä»¶é—´é€šè®¯æ–¹å¼

## çˆ¶å­ç»„ä»¶é€šè®¯

1.props ä¸ $emit

2.parentä¸children

## éš”ä»£ç»„ä»¶é€šè®¯

1.attrsä¸listeners

2.provide å’Œ inject

## çˆ¶å­ã€å…„å¼Ÿã€éš”ä»£ç»„ä»¶é€šè®¯

1.EventBus

2.Vuex

# v-on ç›‘å¬å¤šä¸ªæ–¹æ³•

```vue
<button v-on="{mouseenter: onEnter, mouseleave: onLeave}">é¼ æ ‡è¿›æ¥1</button>`
```

# å¸¸ç”¨çš„ä¿®é¥°ç¬¦

## è¡¨å•ä¿®é¥°ç¬¦

1.lazy: å¤±å»ç„¦ç‚¹ååŒæ­¥ä¿¡æ¯
2.trim: è‡ªåŠ¨è¿‡æ»¤é¦–å°¾ç©ºæ ¼
3.number: è¾“å…¥å€¼è½¬ä¸ºæ•°å€¼ç±»å‹

## äº‹ä»¶ä¿®é¥°ç¬¦

1.stopï¼šé˜»æ­¢å†’æ³¡
2.preventï¼šé˜»æ­¢é»˜è®¤è¡Œä¸º
3.selfï¼šä»…ç»‘å®šå…ƒç´ è‡ªèº«è§¦å‘
4.onceï¼šåªè§¦å‘ä¸€æ¬¡

## é¼ æ ‡æŒ‰é’®ä¿®é¥°ç¬¦

1.leftï¼šé¼ æ ‡å·¦é”®
2.rightï¼šé¼ æ ‡å³é”®
3.middleï¼šé¼ æ ‡ä¸­é—´é”®

# class ä¸ style å¦‚ä½•åŠ¨æ€ç»‘å®š

class å’Œ style å¯ä»¥é€šè¿‡å¯¹è±¡è¯­æ³•å’Œæ•°ç»„è¯­æ³•è¿›è¡ŒåŠ¨æ€ç»‘å®š

å¯¹è±¡å†™æ³•

```vue
<template>
  <div :class="{ active: isActive }"></div>
  <div :style="{ fontSize: fontSize }">
</template>
<script>
export default {
  data() {
    return {
      isActive: true,
      fontSize: 30
    }
  }
}
</script>
```

æ•°ç»„å†™æ³•

```vue
<template>
  <div :class="[activeClass]"></div>
  <div :style="[styleFontSize]">
</template>
<script>
export default {
  data() {
    return {
      activeClass: 'active',
      styleFontSize: {
        fontSize: '12px'
      }
    }
  }
}
</script>
```

# v-show å’Œ v-if åŒºåˆ«

å…±åŒç‚¹ï¼šæ§åˆ¶å…ƒç´ æ˜¾ç¤ºå’Œéšè—ã€‚

ä¸åŒç‚¹ï¼š

1.v-show æ§åˆ¶çš„æ˜¯å…ƒç´ çš„CSSï¼ˆdisplayï¼‰ï¼›v-if æ˜¯æ§åˆ¶å…ƒç´ æœ¬èº«çš„æ·»åŠ æˆ–åˆ é™¤ã€‚

2.show ç”± false å˜ä¸º true çš„æ—¶å€™ä¸ä¼šè§¦å‘ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸã€‚v-if ç”± false å˜ä¸º true åˆ™ä¼šè§¦å‘ç»„ä»¶çš„beforeCreateã€createã€beforeMountã€mountedé’©å­ï¼Œç”± true å˜ä¸º false ä¼šè§¦å‘ç»„ä»¶çš„beforeDestoryã€destoryedæ–¹æ³•ã€‚

3.v-if æ¯” v-showæœ‰æ›´é«˜çš„æ€§èƒ½æ¶ˆè€—ã€‚

#ä¸ºä»€ä¹ˆ v-if ä¸èƒ½å’Œ v-for ä¸€èµ·ä½¿ç”¨

æ€§èƒ½æµªè´¹ï¼Œæ¯æ¬¡æ¸²æŸ“éƒ½è¦å…ˆå¾ªç¯å†è¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼Œè€ƒè™‘ç”¨è®¡ç®—å±æ€§æ›¿ä»£ã€‚

Vue2.xä¸­v-foræ¯”v-ifæ›´é«˜çš„ä¼˜å…ˆçº§ã€‚

Vue3.xä¸­v-if æ¯” v-for æ›´é«˜çš„ä¼˜å…ˆçº§ã€‚

# computed å’Œ watch çš„åŒºåˆ«å’Œè¿ç”¨çš„åœºæ™¯

computed å’Œ watch æœ¬è´¨éƒ½æ˜¯é€šè¿‡å®ä¾‹åŒ– Watcher å®ç°ï¼Œæœ€å¤§åŒºåˆ«å°±æ˜¯é€‚ç”¨åœºæ™¯ä¸åŒã€‚

## computed

è®¡ç®—å±æ€§ï¼Œä¾èµ–å…¶ä»–å±æ€§å€¼ï¼Œä¸”å€¼å…·å¤‡ç¼“å­˜çš„ç‰¹æ€§ã€‚åªæœ‰å®ƒä¾èµ–çš„å±æ€§å€¼å‘ç”Ÿæ”¹å˜ï¼Œä¸‹ä¸€æ¬¡è·å–çš„å€¼æ‰ä¼šé‡æ–°è®¡ç®—ã€‚

é€‚ç”¨äºæ•°å€¼è®¡ç®—ï¼Œå¹¶ä¸”ä¾èµ–äºå…¶ä»–å±æ€§æ—¶ã€‚å› ä¸ºå¯ä»¥åˆ©ç”¨ç¼“å­˜ç‰¹æ€§ï¼Œé¿å…æ¯æ¬¡è·å–å€¼ï¼Œéƒ½éœ€è¦é‡æ–°è®¡ç®—ã€‚

## watch

è§‚å¯Ÿå±æ€§ï¼Œç›‘å¬å±æ€§å€¼å˜åŠ¨ã€‚æ¯å½“å±æ€§å€¼å‘ç”Ÿå˜åŒ–ï¼Œéƒ½ä¼šæ‰§è¡Œç›¸åº”çš„å›è°ƒã€‚

é€‚ç”¨äºæ•°æ®å˜åŒ–æ—¶æ‰§è¡Œå¼‚æ­¥æˆ–å¼€é”€æ¯”è¾ƒå¤§çš„æ“ä½œã€‚

#slot æ’æ§½

slot æ’æ§½ï¼Œå¯ä»¥ç†è§£ä¸ºslotåœ¨ç»„ä»¶æ¨¡æ¿ä¸­æå‰å æ®äº†ä½ç½®ã€‚å½“å¤ç”¨ç»„ä»¶æ—¶ï¼Œä½¿ç”¨ç›¸å…³çš„slotæ ‡ç­¾æ—¶ï¼Œæ ‡ç­¾é‡Œçš„å†…å®¹å°±ä¼šè‡ªåŠ¨æ›¿æ¢ç»„ä»¶æ¨¡æ¿ä¸­å¯¹åº”slotæ ‡ç­¾çš„ä½ç½®ï¼Œä½œä¸ºæ‰¿è½½åˆ†å‘å†…å®¹çš„å‡ºå£ã€‚

ä¸»è¦ä½œç”¨æ˜¯å¤ç”¨å’Œæ‰©å±•ç»„ä»¶ï¼Œåšä¸€äº›å®šåˆ¶åŒ–ç»„ä»¶çš„å¤„ç†ã€‚

æ’æ§½ä¸»è¦æœ‰3ç§

1.é»˜è®¤æ’æ§½

```vue
// å­ç»„ä»¶
<template>
  <slot>
    <div>é»˜è®¤æ’æ§½å¤‡é€‰å†…å®¹</div>
  </slot>
</template>

// çˆ¶ç»„ä»¶
<template>
  <Child>
    <div>æ›¿æ¢é»˜è®¤æ’æ§½å†…å®¹</div>
  </Child>
</template>
```

2.å…·åæ’æ§½

slot æ ‡ç­¾æ²¡æœ‰nameå±æ€§ï¼Œåˆ™ä¸ºé»˜è®¤æ’æ§½ã€‚å…·å¤‡nameå±æ€§ï¼Œåˆ™ä¸ºå…·åæ’æ§½

```vue
// å­ç»„ä»¶
<template>
  <slot>é»˜è®¤æ’æ§½çš„ä½ç½®</slot>
  <slot name="content">æ’æ§½contentå†…å®¹</slot>
</template>

// çˆ¶ç»„ä»¶
<template>
   <Child>
     <template v-slot:default>
       é»˜è®¤...
     </template>
     <template v-slot:content>
       å†…å®¹...
     </template>
   </Child>
</template>
```

3.ä½œç”¨åŸŸæ’æ§½

å­ç»„ä»¶åœ¨ä½œç”¨åŸŸä¸Šç»‘å®šçš„å±æ€§æ¥å°†ç»„ä»¶çš„ä¿¡æ¯ä¼ ç»™çˆ¶ç»„ä»¶ä½¿ç”¨ï¼Œè¿™äº›å±æ€§ä¼šè¢«æŒ‚åœ¨çˆ¶ç»„ä»¶æ¥å—çš„å¯¹è±¡ä¸Šã€‚

```vue
// å­ç»„ä»¶
<template>
  <slot name="footer" childProps="å­ç»„ä»¶">
    ä½œç”¨åŸŸæ’æ§½å†…å®¹
  </slot>
</template>

// çˆ¶ç»„ä»¶
<template>
  <Child v-slot="slotProps">
    {{ slotProps.childProps }}
  </Child>
</template>
```

# Vue.$delete å’Œ delete çš„åŒºåˆ«

Vue.$delete æ˜¯ç›´æ¥åˆ é™¤äº†å…ƒç´ ï¼Œæ”¹å˜äº†æ•°ç»„çš„é•¿åº¦ï¼›delete æ˜¯å°†è¢«åˆ é™¤çš„å…ƒç´ å˜æˆå†… undefined ï¼Œå…¶ä»–å…ƒç´ é”®å€¼ä¸å˜ã€‚

# Vue.$set å¦‚ä½•è§£å†³å¯¹è±¡æ–°å¢å±æ€§ä¸èƒ½å“åº”çš„é—®é¢˜

Vue.$setçš„å‡ºç°æ˜¯ç”±äºObject.definePropertyçš„å±€é™æ€§ï¼šæ— æ³•æ£€æµ‹å¯¹è±¡å±æ€§çš„æ–°å¢æˆ–åˆ é™¤ã€‚

æºç ä½ç½®ï¼švue/src/core/observer/index.js

```javascript
export function set(target, key, val) {
  // æ•°ç»„
  if(Array.isArray(target) && isValidArrayIndex(key)) {
    // ä¿®æ”¹æ•°ç»„é•¿åº¦ï¼Œé¿å…ç´¢å¼•å¤§äºæ•°ç»„é•¿åº¦å¯¼è‡´spliceé”™è¯¯
    target.length = Math.max(target.length, key)
    // åˆ©ç”¨æ•°ç»„spliceè§¦å‘å“åº”
    target.splice(key, 1, val)
    return val
  }
  // key å·²ç»å­˜åœ¨ï¼Œç›´æ¥ä¿®æ”¹å±æ€§å€¼
  if(key in target && !(key in Object.prototype)) {
    target[key] = val
    return val
  }
  const ob = target.__ob__
  // target ä¸æ˜¯å“åº”å¼æ•°æ®ï¼Œç›´æ¥èµ‹å€¼
  if(!ob) {
    target[key] = val
    return val
  }
  // å“åº”å¼å¤„ç†å±æ€§
  defineReactive(ob.value, key, val)
  // æ´¾å‘æ›´æ–°
  ob.dep.notify()
  return val
}
```

å®ç°åŸç†ï¼š

1.è‹¥æ˜¯æ•°ç»„ï¼Œç›´æ¥ä½¿ç”¨æ•°ç»„çš„ splice æ–¹æ³•è§¦å‘å“åº”å¼ã€‚
2.è‹¥æ˜¯å¯¹è±¡ï¼Œåˆ¤æ–­å±æ€§æ˜¯å¦å­˜åœ¨ï¼Œå¯¹è±¡æ˜¯å¦æ˜¯å“åº”å¼ã€‚
3.ä»¥ä¸Šéƒ½ä¸æ»¡è¶³ï¼Œæœ€åé€šè¿‡ defineReactive å¯¹å±æ€§è¿›è¡Œå“åº”å¼å¤„ç†ã€‚

# Vue å¼‚æ­¥æ›´æ–°æœºåˆ¶

Vue å¼‚æ­¥æ›´æ–°æœºåˆ¶æ ¸å¿ƒæ˜¯åˆ©ç”¨æµè§ˆå™¨çš„å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—å®ç°çš„ã€‚

å½“å“åº”å¼æ•°æ®æ›´æ–°åï¼Œä¼šè§¦å‘ dep.notify é€šçŸ¥æ‰€æœ‰çš„ watcher æ‰§è¡Œ update æ–¹æ³•ã€‚

dep ç±»çš„ notify æ–¹æ³•

```javascript
notify() {
  // è·å–æ‰€æœ‰çš„ watcher
  const subs = this.subs.slice()
  // éå† dep ä¸­å­˜å‚¨çš„ watcherï¼Œæ‰§è¡Œ watcher.update
  for(let i = 0; i < subs.length; i++) {
    subs[i].update()
  }
}
```

watcher.update å°†è‡ªèº«æ”¾å…¥å…¨å±€çš„ watcher é˜Ÿåˆ—ï¼Œç­‰å¾…æ‰§è¡Œã€‚

watcher ç±»çš„ update æ–¹æ³•

```javascript
update() {
  if(this.lazy) {
    // æ‡’æ‰§è¡Œèµ°å½“å‰ if åˆ†æ”¯ï¼Œå¦‚ computed
    // è¿™é‡Œçš„ æ ‡è¯† ä¸»è¦ç”¨äº computed ç¼“å­˜å¤ç”¨é€»è¾‘
    this.dirty = true
  } else if(this.sync) {
    // åŒæ­¥æ‰§è¡Œï¼Œåœ¨ watch é€‰é¡¹å‚æ•°ä¼  sync æ—¶ï¼Œèµ°å½“å‰åˆ†æ”¯
    // è‹¥ä¸º true ï¼Œç›´æ¥æ‰§è¡Œ watcher.run()ï¼Œä¸å¡å…¥å¼‚æ­¥æ›´æ–°é˜Ÿåˆ—
    this.run()
  } else {
    // æ­£å¸¸æ›´æ–°èµ°å½“å‰ else åˆ†æ”¯
    queueWatcher(this)
  }
}
```

queueWatcher æ–¹æ³•ï¼Œå‘ç°ç†Ÿæ‚‰çš„ nextTick æ–¹æ³•ã€‚çœ‹åˆ°è¿™å¯ä»¥å…ˆè·³åˆ°nextTickçš„åŸç†ï¼Œçœ‹æ˜ç™½äº†å†æŠ˜è¿”ã€‚ğŸ˜Š

```javascript
function queueWatcher(watcher) {
  const id = watcher.id
  // æ ¹æ® watcher id åˆ¤æ–­æ˜¯å¦åœ¨é˜Ÿåˆ—ä¸­ï¼Œè‹¥åœ¨é˜Ÿåˆ—ä¸­ï¼Œä¸é‡å¤å…¥é˜Ÿ 
  if (has[id] == null) {
    has[id] = true
    // å…¨å±€ queue é˜Ÿåˆ—æœªå¤„äºåˆ·æ–°çŠ¶æ€ï¼Œwatcher å¯å…¥é˜Ÿ
    if (!flushing) {
      queue.push(watcher)
    // å…¨å±€ queue é˜Ÿåˆ—å¤„äºåˆ·æ–°çŠ¶æ€
    // åœ¨å•è°ƒé€’å¢åºåˆ—å¯»æ‰¾å½“å‰ id çš„ä½ç½®å¹¶è¿›è¡Œæ’å…¥æ“ä½œ
    } else {
      let i = queue.length - 1
      while (i > index && queue[i].id > watcher.id) {
        i--
      }
      queue.splice(i + 1, 0, watcher)
    }
   
    if (!waiting) {
      waiting = true
      // åŒæ­¥æ‰§è¡Œé€»è¾‘
      if (process.env.NODE_ENV !== 'production' && !config.async) {
        flushSchedulerQueue()
        return
      }
      // å°†å›è°ƒå‡½æ•° flushSchedulerQueue æ”¾å…¥ callbacks æ•°ç»„
      nextTick(flushSchedulerQueue)
    }
  }
}
```

nextTick å‡½æ•°æœ€ç»ˆå…¶å®æ˜¯æ‰§è¡Œ flushCallbacks å‡½æ•°ï¼ŒflushCallbacks å‡½æ•°åˆ™æ˜¯è¿è¡Œ flushSchedulerQueue å›è°ƒå’Œé¡¹ç›®ä¸­è°ƒç”¨ nextTick å‡½æ•°ä¼ å…¥çš„å›è°ƒã€‚

æ¬è¿ flushSchedulerQueue æºç çœ‹åšäº†äº›ä»€ä¹ˆ

```javascript
/**
*  æ›´æ–° flushing ä¸º trueï¼Œè¡¨ç¤ºæ­£åœ¨åˆ·æ–°é˜Ÿåˆ—ï¼Œåœ¨æ­¤æœŸé—´åŠ å…¥çš„ watcher å¿…é¡»æœ‰åºæ’å…¥é˜Ÿåˆ—ï¼Œä¿è¯å•è°ƒé€’å¢
*  æŒ‰ç…§é˜Ÿåˆ—çš„ watcher.id ä»å°åˆ°å¤§æ’åºï¼Œä¿è¯å…ˆåˆ›å»ºçš„å…ˆæ‰§è¡Œ
*  éå† watcher é˜Ÿåˆ—ï¼ŒæŒ‰åºæ‰§è¡Œ watcher.before å’Œ watcher.runï¼Œæœ€åæ¸…é™¤ç¼“å­˜çš„ watcher
*/
function flushSchedulerQueue () {
  currentFlushTimestamp = getNow()
  // æ ‡è¯†æ­£åœ¨åˆ·æ–°é˜Ÿåˆ—
  flushing = true
  let watcher, id

  queue.sort((a, b) => a.id - b.id)
  // æœªç¼“å­˜é•¿åº¦æ˜¯å› ä¸ºå¯èƒ½åœ¨æ‰§è¡Œ watcher æ—¶åŠ å…¥ watcher
  for (index = 0; index < queue.length; index++) {
    watcher = queue[index]
    if (watcher.before) {
      watcher.before()
    }
    id = watcher.id
    // æ¸…é™¤ç¼“å­˜çš„ watcher
    has[id] = null
    // è§¦å‘æ›´æ–°å‡½æ•°ï¼Œå¦‚ updateComponent æˆ– æ‰§è¡Œç”¨æˆ·çš„ watch å›è°ƒ
    watcher.run()
  }

  
  const activatedQueue = activatedChildren.slice()
  const updatedQueue = queue.slice()
  
  // æ‰§è¡Œ waiting = flushing = falseï¼Œæ ‡è¯†åˆ·æ–°é˜Ÿåˆ—ç»“æŸï¼Œå¯ä»¥å‘æµè§ˆå™¨çš„ä»»åŠ¡é˜Ÿåˆ—åŠ å…¥ä¸‹ä¸€ä¸ª flushCallbacks
  resetSchedulerState()
 
  callActivatedHooks(activatedQueue)
  callUpdatedHooks(updatedQueue)

  if (devtools && config.devtools) {
    devtools.emit('flush')
  }
}
```

æŸ¥çœ‹ä¸‹ watcher.run åšäº†äº›ä»€ä¹ˆï¼Œé¦–å…ˆè°ƒç”¨äº† get å‡½æ•°ï¼Œæˆ‘ä»¬ä¸€èµ·çœ‹ä¸‹ã€‚

```javascript
/**
*  æ‰§è¡Œå®ä¾‹åŒ– watcher ä¼ é€’çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå¦‚ updateComponent
*  æ›´æ–°æ—§å€¼ä¸ºæ–°å€¼
*  æ‰§è¡Œå®ä¾‹åŒ– watcher æ—¶ä¼ é€’çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œç”¨æˆ·ä¼ é€’çš„ watcher å›è°ƒ
*/
run () {
  if (this.active) {
    // è°ƒç”¨ get
    const value = this.get()
    if (
      value !== this.value ||
      isObject(value) ||
      this.deep
    ) {
      // æ›´æ–°æ—§å€¼ä¸ºæ–°å€¼
      const oldValue = this.value
      this.value = value
      // è‹¥æ˜¯é¡¹ç›®ä¼ å…¥çš„ watcherï¼Œåˆ™æ‰§è¡Œå®ä¾‹åŒ–ä¼ é€’çš„å›è°ƒå‡½æ•°ã€‚
      if (this.user) {
        const info = `callback for watcher "${this.expression}"`
        invokeWithErrorHandling(this.cb, this.vm, [value, oldValue], this.vm, info)
      } else {
        this.cb.call(this.vm, value, oldValue)
      }
    }
  }
}
/**
* æ‰§è¡Œ this.getterï¼Œå¹¶é‡æ–°æ”¶é›†ä¾èµ–ã€‚
* é‡æ–°æ”¶é›†ä¾èµ–æ˜¯å› ä¸ºè§¦å‘æ›´æ–° setter ä¸­åªåšäº†å“åº”å¼è§‚æµ‹ï¼Œä½†æ²¡æœ‰æ”¶é›†ä¾èµ–çš„æ“ä½œã€‚
* æ‰€ä»¥ï¼Œåœ¨æ›´æ–°é¡µé¢æ—¶ï¼Œä¼šé‡æ–°æ‰§è¡Œä¸€æ¬¡ render å‡½æ•°ï¼Œæ‰§è¡ŒæœŸé—´ä¼šè§¦å‘è¯»å–æ“ä½œï¼Œè¿™æ—¶è¿›è¡Œä¾èµ–æ”¶é›†ã€‚
*/
get () {
  // Dep.target = this
  pushTarget(this)
  let value
  const vm = this.vm
  try {
    // æ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œå¦‚ updateComponentï¼Œè¿›å…¥ patch é˜¶æ®µ
    value = this.getter.call(vm, vm)
  } catch (e) {
    if (this.user) {
      handleError(e, vm, `getter for watcher "${this.expression}"`)
    } else {
      throw e
    }
  } finally {
    // watch å‚æ•°ä¸º deep çš„æƒ…å†µ
    if (this.deep) {
      traverse(value)
    }
    // å…³é—­ Dep.target ç½®ç©º
    popTarget()
    this.cleanupDeps()
  }
  return value
}
```

# Vue.$nextTick çš„åŸç†

nextTickï¼šåœ¨ä¸‹æ¬¡ DOM æ›´æ–°å¾ªç¯ç»“æŸä¹‹åæ‰§è¡Œå»¶è¿Ÿå›è°ƒã€‚å¸¸ç”¨äºä¿®æ”¹æ•°æ®åè·å–æ›´æ–°åçš„DOMã€‚

æºç ä½ç½®ï¼švue/src/core/util/next-tick.js

```javascript
import { noop } from 'shared/util'
import { handleError } from './error'
import { isIE, isIOS, isNative } from './env'

// æ˜¯å¦ä½¿ç”¨å¾®ä»»åŠ¡æ ‡è¯†
export let isUsingMicroTask = false

// å›è°ƒå‡½æ•°é˜Ÿåˆ—
const callbacks = []
// å¼‚æ­¥é”
let pending = false

function flushCallbacks () {
  // è¡¨ç¤ºä¸‹ä¸€ä¸ª flushCallbacks å¯ä»¥è¿›å…¥æµè§ˆå™¨çš„ä»»åŠ¡é˜Ÿåˆ—äº†
  pending = false
  // é˜²æ­¢ nextTick ä¸­åŒ…å« nextTickæ—¶å‡ºç°é—®é¢˜ï¼Œåœ¨æ‰§è¡Œå›è°ƒå‡½æ•°é˜Ÿåˆ—å‰ï¼Œæå‰å¤åˆ¶å¤‡ä»½ï¼Œæ¸…ç©ºå›è°ƒå‡½æ•°é˜Ÿåˆ—
  const copies = callbacks.slice(0)
  // æ¸…ç©º callbacks æ•°ç»„
  callbacks.length = 0
  for (let i = 0; i < copies.length; i++) {
    copies[i]()
  }
}

let timerFunc

// æµè§ˆå™¨èƒ½åŠ›æ£€æµ‹
// ä½¿ç”¨å®ä»»åŠ¡æˆ–å¾®ä»»åŠ¡çš„ç›®çš„æ˜¯å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡å¿…åœ¨åŒæ­¥ä»£ç ç»“æŸä¹‹åæ‰§è¡Œï¼Œè¿™æ—¶èƒ½ä¿è¯æ˜¯æœ€ç»ˆæ¸²æŸ“å¥½çš„DOMã€‚
// å®ä»»åŠ¡è€—è´¹æ—¶é—´æ˜¯å¤§äºå¾®ä»»åŠ¡ï¼Œåœ¨æµè§ˆå™¨æ”¯æŒçš„æƒ…å†µä¸‹ï¼Œä¼˜å…ˆä½¿ç”¨å¾®ä»»åŠ¡ã€‚
// å®ä»»åŠ¡ä¸­æ•ˆç‡ä¹Ÿæœ‰å·®è·ï¼Œæœ€ä½çš„å°±æ˜¯ setTimeout
if (typeof Promise !== 'undefined' && isNative(Promise)) {
  const p = Promise.resolve()
  timerFunc = () => {
    p.then(flushCallbacks)
    if (isIOS) setTimeout(noop)
  }
  isUsingMicroTask = true
} else if (!isIE && typeof MutationObserver !== 'undefined' && (
  isNative(MutationObserver) ||
  MutationObserver.toString() === '[object MutationObserverConstructor]'
)) {
  let counter = 1
  const observer = new MutationObserver(flushCallbacks)
  const textNode = document.createTextNode(String(counter))
  observer.observe(textNode, {
    characterData: true
  })
  timerFunc = () => {
    counter = (counter + 1) % 2
    textNode.data = String(counter)
  }
  isUsingMicroTask = true
} else if (typeof setImmediate !== 'undefined' && isNative(setImmediate)) {
  timerFunc = () => {
    setImmediate(flushCallbacks)
  }
} else {
  timerFunc = () => {
    setTimeout(flushCallbacks, 0)
  }
}

export function nextTick (cb?: Function, ctx?: Object) {
  let _resolve
  // å°† nextTick çš„å›è°ƒå‡½æ•°ç”¨ try catch åŒ…è£¹ä¸€å±‚ï¼Œç”¨äºå¼‚å¸¸æ•è·
  // å°†åŒ…è£¹åçš„å‡½æ•°æ”¾åˆ° callback ä¸­
  callbacks.push(() => {
    if (cb) {
      try {
        cb.call(ctx)
      } catch (e) {
        handleError(e, ctx, 'nextTick')
      }
    } else if (_resolve) {
      _resolve(ctx)
    }
  })
  // pengding ä¸º false, æ‰§è¡Œ timerFunc
  if (!pending) {
    // å…³ä¸Šé”
    pending = true
    timerFunc()
  }
  if (!cb && typeof Promise !== 'undefined') {
    return new Promise(resolve => {
      _resolve = resolve
    })
  }
}

```

æ€»ç»“ï¼š

1.è¿ç”¨å¼‚æ­¥é”çš„æ¦‚å¿µï¼Œä¿è¯åŒä¸€æ—¶åˆ»ä»»åŠ¡é˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ª flushCallbacksã€‚å½“ pengding ä¸º false çš„æ—¶å€™ï¼Œè¡¨ç¤ºæµè§ˆå™¨ä»»åŠ¡é˜Ÿåˆ—ä¸­æ²¡æœ‰ flushCallbacks å‡½æ•°ï¼›å½“ pengding ä¸º true çš„æ—¶å€™ï¼Œè¡¨ç¤ºæµè§ˆå™¨ä»»åŠ¡é˜Ÿåˆ—ä¸­å·²ç»æ”¾å…¥ flushCallbacksï¼›å¾…æ‰§è¡Œ flushCallback å‡½æ•°æ—¶ï¼Œpengding ä¼šè¢«å†æ¬¡ç½®ä¸º falseï¼Œè¡¨ç¤ºä¸‹ä¸€ä¸ª flushCallbacks å¯è¿›å…¥ä»»åŠ¡é˜Ÿåˆ—ã€‚
2.ç¯å¢ƒèƒ½åŠ›æ£€æµ‹ï¼Œé€‰æ‹©å¯é€‰ä¸­æ•ˆç‡æœ€é«˜çš„ï¼ˆå®ä»»åŠ¡/å¾®ä»»åŠ¡ï¼‰è¿›è¡ŒåŒ…è£…æ‰§è¡Œï¼Œä¿è¯æ˜¯åœ¨åŒæ­¥ä»£ç éƒ½æ‰§è¡Œå®Œæˆåå†å»æ‰§è¡Œä¿®æ”¹ DOM ç­‰æ“ä½œã€‚
3.flushCallbacks å…ˆæ‹·è´å†æ¸…ç©ºï¼Œä¸ºäº†é˜²æ­¢nextTickåµŒå¥—nextTickå¯¼è‡´å¾ªç¯ä¸ç»“æŸã€‚

# å®ç°è™šæ‹Ÿ DOM

è™šæ‹Ÿ DOM çš„å‡ºç°è§£å†³äº†æµè§ˆå™¨çš„æ€§èƒ½é—®é¢˜ã€‚è™šæ‹Ÿ DOM æ˜¯ä¸€ä¸ªç”¨ JS æ¨¡æ‹Ÿçš„ DOM ç»“æ„å¯¹è±¡(Vnode)ï¼Œç”¨äºé¢‘ç¹æ›´æ”¹ DOM æ“ä½œåä¸ç«‹å³æ›´æ–° DOMï¼Œè€Œæ˜¯å¯¹æ¯”æ–°è€ Vnodeï¼Œæ›´æ–°è·å–æœ€æ–°çš„Vnodeï¼Œæœ€åå†ä¸€æ¬¡æ€§æ˜ å°„æˆçœŸå®çš„ DOMã€‚è¿™æ ·åšçš„åŸå› æ˜¯æ“ä½œå†…å­˜ä¸­æ“ä½œ JS å¯¹è±¡é€Ÿåº¦æ¯”æ“ä½œ DOM å¿«å¾ˆå¤šã€‚

ä¸¾ä¸ªçœŸå® DOM çš„ ğŸŒ°

```html
<div id="container">
  <p>real dom </p>
  <ul>
    <li class="item">item 1</li>
    <li class="item">item 2</li>
    <li class="item">item 3</li>
  </ul>
</div
```

ç”¨ JS æ¥æ¨¡æ‹Ÿ DOM èŠ‚ç‚¹å®ç°è™šæ‹Ÿ DOM

```javascript
function Element(tagName, props, children) {
  this.tageName = tagName
  this.props = props || {}
  this.children = children || []
  this.key = props.key
  let count = 0
  this.children.forEach(child => {
    if(child instanceof Element) count += child.count
    count++
  })
  this.count = count
}
const tree = Element('div', { id: container }, [
  Element('p', {}, ['real dom'])
  Element('ul', {}, [
    Element('li', { class: 'item' }, ['item1']),
    Element('li', { class: 'item' }, ['item2']),
    Element('li', { class: 'item' }, ['item3'])
  ])
])
```

è™šæ‹Ÿ DOM è½¬ä¸ºçœŸå®çš„èŠ‚ç‚¹

```javascript
Element.prototype.render = function() {
  let el = document.createElement(this.tagName)
  let props = this.props
  for(let key in props) {
    el.setAttribute(key, props[key])
  }
  let children = this.children || []
  children.forEach(child => {
    let child = (child instanceof Element) ? child.render() : document.createTextNode(child)
    el.appendChild(child)
  })
  return el
}
```

# Vue ä¸­ Diff çš„åŸç†

æ ¸å¿ƒæºç ï¼švue/src/core/vdom/patch.js

æ¬è¿å¯¹æ¯”æ–°è€èŠ‚ç‚¹ patch å‡½æ•°å…¥å£

```javascript
/**
* æ–°èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œè€èŠ‚ç‚¹å­˜åœ¨ï¼Œè°ƒç”¨ destroyï¼Œé”€æ¯è€èŠ‚ç‚¹
* å¦‚æœ oldVnode æ˜¯çœŸå®å…ƒç´ ï¼Œåˆ™è¡¨ç¤ºé¦–æ¬¡æ¸²æŸ“ï¼Œåˆ›å»ºæ–°èŠ‚ç‚¹ï¼Œå¹¶æ’å…¥ bodyï¼Œç„¶åç§»é™¤æ¥èŠ‚ç‚¹
* å¦‚æœ oldVnode ä¸æ˜¯çœŸå®å…ƒç´ ï¼Œåˆ™è¡¨ç¤ºæ›´æ–°é˜¶æ®µï¼Œæ‰§è¡ŒpatchVnode
*/
function patch(oldVnode, vnode) {
  // æ–°çš„ Vnode ä¸å­˜åœ¨ï¼Œè€çš„ Vnode å­˜åœ¨ï¼Œé”€æ¯è€èŠ‚ç‚¹
  if(isUndef(vnode)) {
    if(isDef(oldVnode)) invokeDestroyHook(oldVnode) 
    return 
  }
  
  // æ–°çš„ Vnode å­˜åœ¨ï¼Œè€çš„ Vnode ä¸å­˜åœ¨
  // <div id="app"><comp></comp></div>
  // è¿™é‡Œçš„ com ç»„ä»¶åˆæ¬¡æ¸²æŸ“å°±èµ°å½“å‰çš„ if é€»è¾‘
  if(isUndef(oldVnode)) { 
    isInitialPatch = true
    createElm(vnode, insertedVnodeQueue)
  } else {
      const isRealElement = isDef(oldVnode.nodeType)
      // æ–°è€èŠ‚ç‚¹ç›¸åŒï¼Œæ›´ç²¾ç»†åŒ–å¯¹æ¯”
      if(!isRealElement && sameVnode(oldVnode, vnode)) {
        patchVnode(oldVnode, vnode) 
      } else {
        // æ˜¯çœŸå®å…ƒç´ ï¼Œæ¸²æŸ“æ ¹ç»„ä»¶
        if(isRealElement) { 
          // æŒ‚è½½åˆ°çœŸå®å…ƒç´ ä»¥åŠå¤„ç†æœåŠ¡ç«¯æ¸²æŸ“æƒ…å†µ
          if (oldVnode.nodeType === 1 && oldVnode.hasAttribute(SSR_ATTR)) {
            oldVnode.removeAttribute(SSR_ATTR)
            hydrating = true
          }
          if (isTrue(hydrating)) {
            if (hydrate(oldVnode, vnode, insertedVnodeQueue)) {
              invokeInsertHook(vnode, insertedVnodeQueue, true)
              return oldVnode
            } else if (process.env.NODE_ENV !== 'production') {
              warn(
                'The client-side rendered virtual DOM tree is not matching ' +
                'server-rendered content. This is likely caused by incorrect ' +
                'HTML markup, for example nesting block-level elements inside ' +
                '<p>, or missing <tbody>. Bailing hydration and performing ' +
                'full client-side render.'
              )
            }
          }
          // åŸºäºçœŸå®èŠ‚ç‚¹åˆ›å»ºä¸€ä¸ª vnode
          oldVnode = emptyNodeAt(oldVnode)
       }
       // è·å–è€èŠ‚ç‚¹çš„çœŸå®å…ƒç´ 
       const oldElm = oldVnode.elm
       // è·å–è€èŠ‚ç‚¹çš„çˆ¶å…ƒç´ ï¼Œå³ body
       const parentElm = nodeOps.parentNode(oldElm)
       
       // åŸºäºæ–°çš„ vnode åˆ›å»ºæ•´é¢— DOM æ ‘å¹¶æ’å…¥åˆ° body å…ƒç´ ä¸‹
       creatElm(
         vnode, 
         insertedVnodeQueue, 
         oldElm._leaveCb ? null : parentElm, 
         nodeOps.nextSibling(oldElm)
       )
       
       // é€’å½’æ›´æ–°çˆ¶å ä½ç¬¦èŠ‚ç‚¹å…ƒç´ 
       if(isDef(vnode.parent)) {
         ...
       }
       
       // ç§»é™¤è€èŠ‚ç‚¹
       if(isDef(parentEle)) {
         ...
       } else if(isDef(oldVnode.tag)) {
         ...
       }
    }
  }
}
```

æ¬è¿ patchVnode éƒ¨åˆ†æºç ã€‚

```javascript
/**
* æ›´æ–°èŠ‚ç‚¹
* å¦‚æœæ–°è€èŠ‚ç‚¹éƒ½æœ‰å­©å­ï¼Œåˆ™é€’å½’æ‰§è¡Œ updateChildren
* å¦‚æœæ–°èŠ‚ç‚¹æœ‰å­©å­ï¼Œè€èŠ‚ç‚¹æ²¡å­©å­ï¼Œåˆ™æ–°å¢æ–°èŠ‚ç‚¹çš„è¿™äº›å­©å­èŠ‚ç‚¹
* å¦‚æœè€èŠ‚ç‚¹æœ‰å­©å­ï¼Œæ–°èŠ‚ç‚¹æ²¡å­©å­ï¼Œåˆ™åˆ é™¤è€èŠ‚ç‚¹è¿™äº›å­©å­
* æ›´æ–°æ–‡æœ¬èŠ‚ç‚¹
*/
function patchVnode(oldVnode, vnode) {
  // å¦‚æœæ–°è€èŠ‚ç‚¹ç›¸åŒï¼Œç›´æ¥è¿”å›   
  if(oldVnode === vnode) return 
  
  // è·å–æ–°è€èŠ‚ç‚¹çš„å­©å­èŠ‚ç‚¹
  const oldCh = oldVnode.children
  const ch = vnode.children
  
  // æ–°èŠ‚ç‚¹ä¸æ˜¯æ–‡æœ¬èŠ‚ç‚¹
  if(isUndef(vnode.text)) {
    // æ–°è€èŠ‚ç‚¹éƒ½æœ‰å­©å­ï¼Œåˆ™é€’å½’æ‰§è¡Œ updateChildren
    if(isDef(oldCh) && isDef(ch) && oldCh !== ch) { // oldVnode ä¸ vnode çš„ children ä¸ä¸€è‡´ï¼Œæ›´æ–°children
      updateChildren(oldCh,ch)
    // å¦‚æœæ–°èŠ‚ç‚¹æœ‰å­©å­ï¼Œè€èŠ‚ç‚¹æ²¡å­©å­ï¼Œåˆ™æ–°å¢æ–°èŠ‚ç‚¹çš„è¿™äº›å­©å­èŠ‚ç‚¹
    } else if(isDef(ch)) { 
      if (isDef(oldVnode.text)) nodeOps.setTextContent(elm, '')
      addVnodes(elm, null, ch, 0, ch.length - 1, insertedVnodeQueue)
    // å¦‚æœè€èŠ‚ç‚¹æœ‰å­©å­ï¼Œæ–°èŠ‚ç‚¹æ²¡å­©å­ï¼Œåˆ™åˆ é™¤è€èŠ‚ç‚¹è¿™äº›å­©å­
    } else if(isDef(oldCh)) { 
      removeVnodes(oldCh, 0, oldCh.length - 1)
    // è€èŠ‚ç‚¹æ–‡æœ¬å­˜åœ¨ï¼Œæ–°çš„èŠ‚ç‚¹ä¸å­˜åœ¨æ–‡æœ¬ï¼Œæ¸…ç©ºæ–‡æœ¬ 
    } else if(isDef(oldVnode.text)){
      nodeOps.setTextContent(elm, '')
    }
  // æ–°è€æ–‡æœ¬èŠ‚ç‚¹éƒ½æ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œä¸”æ–‡æœ¬å‘ç”Ÿæ”¹å˜ï¼Œåˆ™æ›´æ–°æ–‡æœ¬èŠ‚ç‚¹
  } else if(oldVnode.text !== vnode.text) { 
    nodeOps.setTextContent(elm, vnode.text)
  }
}
```


æ¬è¿ updateChildren æºç ã€‚

```javascript
function updateChildren(oldCh, ch) {
   // const oldCh = [n1, n2, n3, n4]
   // const ch = [n1, n2, n3, n4, n5]
   // æ—§èŠ‚ç‚¹èµ·å§‹ç´¢å¼•
   let oldStartIdx = 0 
   // æ–°èŠ‚ç‚¹èµ·å§‹ç´¢å¼•
   let newStartIdx = 0 
   // æ—§èŠ‚ç‚¹ç»“æŸç´¢å¼•
   let oldEndIdx = oldCh.length - 1 
   // æ–°èŠ‚ç‚¹ç»“æŸç´¢å¼•
   let newEndIdx = newCh.length - 1 
   while(oldStartIdx <= oldEndIdx && newStartIdx <= newEndIdx) {
     const newStartVnode = ch[newStartIdx]
     const oldStartVnode = oldCh[oldStartIdx]
     const newEndVnode = ch[newEndIdx]
     const oldEndVnode = oldCh[oldEndIdx]
     // å¦‚æœèŠ‚ç‚¹è¢«ç§»åŠ¨ï¼Œåœ¨å½“å‰ç´¢å¼•ä¸Šå¯èƒ½ä¸å­˜åœ¨ï¼Œæ£€æµ‹è¿™ç§æƒ…å†µï¼Œå¦‚æœèŠ‚ç‚¹ä¸å­˜åœ¨åˆ™è°ƒæ•´ç´¢å¼•
     if(isUndef(oldStartVnode)) {
       oldStartVnode = oldCh[++oldStartIdx]
     } else if(isUndef(oldEndVnode)) {
       oldEndVnode = oldCh[--oldEndIdx]
     // æ–°å¼€å§‹å’Œè€å¼€å§‹èŠ‚ç‚¹æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹
     } else if(sameVnode(oldStartNode, newStartNode)) { 
       patchVnode(oldStartNode , newStartNode)
       oldStartIdx++
       newStartIdx++
     // æ–°å¼€å§‹èŠ‚ç‚¹å’Œè€ç»“æŸèŠ‚ç‚¹æ˜¯åŒä¸€èŠ‚ç‚¹
     } else if(sameVnode(oldEndNode, newEndNode)) { 
       patchVnode(oldEndNode, newEndNode)
       oldEndIdx--
       newEndIdx--
     // è€å¼€å§‹å’Œæ–°ç»“æŸæ˜¯åŒä¸€èŠ‚ç‚¹
     } else if(sameVnode(oldStartNode, newEndNode)) { 
       patchVnode(oldStartNode, newEndNode)
       oldStartIdx++
       newEndIdx--
     // è€ç»“æŸå’Œæ–°å¼€å§‹æ˜¯åŒä¸€èŠ‚ç‚¹
     } else if(sameVnode(oldEndNode, newStartNode)) { 
       patchVnode(oldEndNode, newStartNode)
       oldEndIdx--
       newStartIdx++
     } else {
       // ä¸Šé¢å‡è®¾éƒ½ä¸æˆç«‹ï¼Œåˆ™é€šè¿‡éå†æ‰¾åˆ°æ–°å¼€å§‹èŠ‚ç‚¹å’Œè€èŠ‚ç‚¹ä¸­çš„ç´¢å¼•ä½ç½®
       
       // åˆ›å»ºè€èŠ‚ç‚¹æ¯ä¸ªèŠ‚ç‚¹ key å’Œ ç´¢å¼•çš„å…³ç³» { key: idx }
       if (isUndef(oldKeyToIdx)) oldKeyToIdx = createKeyToOldIdx(oldCh, oldStartIdx, oldEndIdx)
       // å¯»æ‰¾æ–°å¼€å§‹èŠ‚ç‚¹åœ¨è€èŠ‚ç‚¹çš„ç´¢å¼•ä½ç½®
       idxInOld = isDef(newStartVnode.key)
         ? oldKeyToIdx[newStartVnode.key]
         : findIdxInOld(newStartVnode, oldCh, oldStartIdx, oldEndIdx)
       
       // æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™è¯´æ˜æ˜¯æ–°åˆ›å»ºçš„å…ƒç´ ï¼Œæ‰§è¡Œåˆ›å»º
       if (isUndef(idxInOld)) { 
          createElm(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.elm, false, newCh, newStartIdx)
        } else {
          // åœ¨å…³ç³»æ˜ å°„è¡¨ä¸­æ‰¾åˆ°æ–°å¼€å§‹èŠ‚ç‚¹
          vnodeToMove = oldCh[idxInOld]
          // å¦‚æœæ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ™æ‰§è¡Œpatch
          if (sameVnode(vnodeToMove, newStartVnode)) {
            patchVnode(vnodeToMove, newStartVnode, insertedVnodeQueue, newCh, newStartIdx)
            // patch ç»“æŸåå°†è€èŠ‚ç‚¹ç½®ä¸º undefined
            oldCh[idxInOld] = undefined
            canMove && nodeOps.insertBefore(parentElm, vnodeToMove.elm, oldStartVnode.elm)
          } else {
          // æœ€åè¿™ç§æƒ…å†µæ˜¯ï¼Œæ‰¾åˆ°èŠ‚ç‚¹ï¼Œä½†å‘ç°ä¸¤ä¸ªèŠ‚ç‚¹ä¸æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ™è§†ä¸ºæ–°å…ƒç´ ï¼Œæ‰§è¡Œåˆ›å»º
            createElm(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.elm, false, newCh, newStartIdx)
          }
        }
        // æ–°èŠ‚ç‚¹å‘åç§»åŠ¨ä¸€ä½
        newStartVnode = newCh[++newStartIdx]
     }
     if(newStartIdx < newEndIdx) {} // æ—§èŠ‚ç‚¹å…ˆéå†ç»“æŸï¼Œå°†å‰©ä½™çš„æ–°èŠ‚ç‚¹æ·»åŠ åˆ°DOMä¸­
     if(oldStartIdx < oldEndIdx) {} // æ–°èŠ‚ç‚¹å…ˆéå†ç»“æŸï¼Œå°†å‰©ä½™çš„æ—§èŠ‚ç‚¹åˆ æ‰
   }
}
```

# Vue ä¸­çš„ key çš„ä½œç”¨

key æ˜¯ Vue ä¸­ vnode çš„å”¯ä¸€æ ‡è®°ï¼Œæˆ‘ä»¬çš„ diff çš„ç®—æ³•ä¸­ sameVnode å’Œ updateChildren ä¸­å°±ä½¿ç”¨åˆ°äº† keyã€‚

sameVnode ç”¨æ¥åˆ¤æ–­æ˜¯å¦ä¸ºåŒä¸€èŠ‚ç‚¹ã€‚å¸¸è§çš„ä¸šåŠ¡åœºæ™¯æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œè‹¥ key å€¼æ˜¯åˆ—è¡¨ç´¢å¼•ï¼Œåœ¨æ–°å¢æˆ–åˆ é™¤çš„æƒ…å†µä¸‹ä¼šå­˜åœ¨å°±åœ°å¤ç”¨çš„é—®é¢˜ã€‚ï¼ˆç®€å•è¯´ï¼Œå¤ç”¨äº†ä¸Šä¸€ä¸ªåœ¨å½“å‰ä½ç½®å…ƒç´ çš„çŠ¶æ€ï¼‰æ‰€ä»¥ key å€¼çš„å”¯ä¸€ï¼Œç¡®ä¿ diff æ›´å‡†ç¡®ã€‚

updateChildren ä¸­å½“å…¶ä¸­å››ç§å‡è®¾éƒ½æœªåŒ¹é…ï¼Œå°±éœ€è¦ä¾èµ–è€èŠ‚ç‚¹çš„ key å’Œ ç´¢å¼•åˆ›å»ºå…³ç³»æ˜ å°„è¡¨ï¼Œå†ç”¨æ–°èŠ‚ç‚¹çš„ key å»å…³ç³»æ˜ å°„è¡¨å»å¯»æ‰¾ç´¢å¼•è¿›è¡Œæ›´æ–°ï¼Œè¿™ä¿è¯ diff ç®—æ³•æ›´åŠ å¿«é€Ÿã€‚

# Vue åŠ¨æ€ç»„ä»¶æ˜¯ä»€ä¹ˆ

åŠ¨æ€ç»„ä»¶é€šè¿‡isç‰¹æ€§å®ç°ã€‚é€‚ç”¨äºæ ¹æ®æ•°æ®ã€åŠ¨æ€æ¸²æŸ“çš„åœºæ™¯ï¼Œå³ç»„ä»¶ç±»å‹ä¸ç¡®å®šã€‚

```vue
<template>
  <div v-for="val in componentsData" :key="val.id">
    <component :is="val.type">
  </div>
</template>
<script>
import CustomTitle from './CustomTitle'
import CustomText from './CustomText'
import CustomImage from './CustomImage'

export default {
  data() {
    return {
      componentsData: [{
        id: 1,
        type: 'CustomTitle'
      },{
        id: 2,
        type: 'CustomText'
      },{
        id: 3
        type: 'CustomImage'
      }]
    }
  }
}
</script>
```

# Vue.directive æœ‰å†™è¿‡ä¹ˆï¼Œåº”ç”¨åœºæ™¯æœ‰å“ªäº›ï¼Ÿ

Vue.directive å¯ä»¥æ³¨å†Œå…¨å±€æŒ‡ä»¤å’Œå±€éƒ¨æŒ‡ä»¤ã€‚

æŒ‡ä»¤å®šä¹‰å‡½æ•°æä¾›å¦‚ä¸‹é’©å­å‡½æ•°

bindï¼šæŒ‡ä»¤ç¬¬ä¸€æ¬¡ç»‘å®šåˆ°å…ƒç´ æ—¶è°ƒç”¨ï¼ˆåªè°ƒç”¨ä¸€æ¬¡ï¼‰
inserted: è¢«ç»‘å®šå…ƒç´ æ’å…¥çˆ¶èŠ‚ç‚¹æ—¶ä½¿ç”¨ï¼ˆçˆ¶èŠ‚ç‚¹å­˜åœ¨å³å¯è°ƒç”¨ï¼‰
updateï¼šè¢«ç»‘å®šå…ƒç´ æ‰€åœ¨æ¨¡æ¿æ›´æ–°æ—¶è°ƒç”¨ï¼Œä¸è®ºç»‘å®šå€¼æ˜¯å¦å˜åŒ–ã€‚é€šè¿‡æ¯”è¾ƒæ›´æ–°å‰åçš„ç»‘å®šå€¼ã€‚
componentUpdated: è¢«ç»‘å®šå…ƒç´ æ‰€åœ¨æ¨¡æ¿å®Œæˆä¸€æ¬¡æ›´æ–°å‘¨æœŸæ—¶è°ƒç”¨ã€‚
unbind: åªè°ƒç”¨ä¸€æ¬¡ï¼ŒæŒ‡ä»¤ä¸å…ƒç´ è§£ç»‘æ—¶è°ƒç”¨ã€‚
æˆ‘é¡¹ç›®ä¸­æœ‰æ¶‰åŠ ä¸€é”®copyã€æƒé™æ§åˆ¶ éƒ½å¯ä»¥ç”¨æŒ‡ä»¤çš„æ–¹å¼æ§åˆ¶ï¼Œç›®çš„å°±æ˜¯ç®€åŒ–æˆ‘ä»¬çš„å·¥ä½œé‡ã€‚

# Vue è¿‡æ»¤å™¨äº†è§£ä¹ˆ

Vue è¿‡æ»¤å™¨å¯ç”¨åœ¨ä¸¤ä¸ªåœ°æ–¹ï¼šåŒèŠ±æ‹¬å·æ’å€¼å’Œ v-bind è¡¨è¾¾å¼ã€‚

Vue3 ä¸­å·²ç»åºŸå¼ƒè¿™ä¸ªç‰¹ç‚¹ã€‚

è¿‡æ»¤å™¨åˆ†ä¸º å…¨å±€è¿‡æ»¤å™¨ å’Œ å±€éƒ¨è¿‡æ»¤å™¨ã€‚

å±€éƒ¨è¿‡æ»¤å™¨


```vue
<template>
  <div>{{ message | formatMessage }}</div>
</template>
<script>
export default {
  filters: {
    formatMessage: function(value) {
      // å¯åŸºäºæºå€¼åšä¸€äº›å¤„ç†
      return value
    }
  }
}
</script>
```

å…¨å±€è¿‡æ»¤å™¨


```javascript
Vue.filter('formatMessage', function(value) {
  // å¯åŸºäºæºå€¼åšä¸€äº›å¤„ç†
  return value
})
```

è¿‡æ»¤å™¨å¯ä¸²è”ï¼Œæ‰§è¡Œé¡ºåºä»å·¦åˆ°å³ï¼Œç¬¬äºŒä¸ªè¿‡æ»¤å™¨è¾“å…¥å€¼æ˜¯ç¬¬ä¸€ä¸ªè¿‡æ»¤å™¨çš„è¾“å‡ºå€¼ã€‚

```vue
<div>{{ message | formatMessage1 | formatMessage2 }}</div>
```

# å…³äº mixin çš„ç†è§£ï¼Œæœ‰ä»€ä¹ˆåº”ç”¨åœºæ™¯

å®šä¹‰ï¼šmixinï¼ˆæ··å…¥ï¼‰ï¼Œæä¾›äº†ä¸€ç§éå¸¸çµæ´»çš„æ–¹å¼ï¼Œæ¥åˆ†å‘ Vue ç»„ä»¶ä¸­å¯å¤ç”¨çš„åŠŸèƒ½ã€‚

mixin æ··å…¥åˆ†å…¨å±€æ··å…¥å’Œå±€éƒ¨æ··å…¥ï¼Œæœ¬è´¨æ˜¯ JS å¯¹è±¡ï¼Œå¦‚ dataã€componentsã€computedã€methods ç­‰ã€‚

å…¨å±€æ··å…¥ä¸æ¨èä½¿ç”¨ï¼Œä¼šå½±å“åç»­æ¯ä¸ªVueå®ä¾‹çš„åˆ›å»ºã€‚å±€éƒ¨æ··å…¥å¯æå–ç»„ä»¶é—´ç›¸åŒçš„ä»£ç ï¼Œè¿›è¡Œé€»è¾‘å¤ç”¨ã€‚

é€‚ç”¨åœºæ™¯ï¼šå¦‚å¤šä¸ªé¡µé¢å…·å¤‡ç›¸åŒçš„æ‚¬æµ®å®šä½æµ®çª—ï¼Œå¯å°è¯•ç”¨ mixin å°è£…ã€‚

```vue
<script>
// customFloatDialog.js
export const customFloatDialog = {
  data() {
    return {
      visible: false
    }
  },
  methods: {
    toggleShow() {
      this.visible = !this.visible
    }
  }
}
</script>

//éœ€è¦å¼•å…¥çš„ç»„ä»¶
<template>
  <div></div>
</template>
<script>
import { customFloatDialog } from './customFloatDialog.js'
export default {
  mixins: [customFloatDialog],
}
</script>
```

# ä»‹ç»ä¸€ä¸‹ keep-alive

keep-alive æ˜¯ Vue å†…ç½®çš„ä¸€ä¸ªç»„ä»¶ï¼Œå¯ä»¥ç¼“å­˜ç»„ä»¶çš„çŠ¶æ€ï¼Œé¿å…é‡å¤æ¸²æŸ“ï¼Œæé«˜æ€§èƒ½ã€‚

keep-alive å†…ç½®ç»„ä»¶æœ‰3ä¸ªå±æ€§

1.includeï¼šå­—ç¬¦ä¸²æˆ–æ­£åˆ™è¡¨è¾¾å¼ï¼Œåç§°åŒ¹é…çš„ç»„ä»¶ä¼šè¢«ç¼“å­˜ã€‚
2.excludeï¼šå­—ç¬¦ä¸²æˆ–æ­£åˆ™è¡¨è¾¾å¼ï¼Œåç§°åŒ¹é…çš„ç»„ä»¶ä¸ä¼šè¢«ç¼“å­˜ã€‚
3.maxï¼šç¼“å­˜ç»„ä»¶æ•°é‡é˜ˆå€¼

è®¾ç½® keep-alive çš„ç»„ä»¶ï¼Œä¼šå¢åŠ ä¸¤ä¸ªç”Ÿå‘½é’©å­ï¼ˆactivated / deactivatedï¼‰

é¦–æ¬¡è¿›å…¥ç»„ä»¶ï¼šbeforeCreate -> created -> beforeMount -> mounted -> activated

ç¦»å¼€ç»„ä»¶è§¦å‘deactivatedï¼Œå› ä¸ºç»„ä»¶ç¼“å­˜ä¸é”€æ¯ï¼Œæ‰€ä»¥ä¸ä¼šè§¦å‘ beforeDestroy å’Œ destroyed ç”Ÿå‘½é’©å­ã€‚å†æ¬¡è¿›å…¥ç»„ä»¶åç›´æ¥ä» activated ç”Ÿå‘½é’©å­å¼€å§‹ã€‚

å¸¸è§ä¸šåŠ¡åœºæ™¯ï¼šåœ¨åˆ—è¡¨é¡µçš„ç¬¬ 2 é¡µè¿›å…¥è¯¦æƒ…é¡µï¼Œè¯¦æƒ…é¡µè¿”å›ï¼Œä¾ç„¶åœç•™åœ¨ç¬¬ 2 é¡µï¼Œä¸é‡æ–°æ¸²æŸ“ã€‚ä½†ä»å…¶ä»–é¡µé¢è¿›å…¥åˆ—è¡¨é¡µï¼Œè¿˜æ˜¯éœ€è¦é‡æ–°æ¸²æŸ“ã€‚

æ€è·¯ï¼švuex ä½¿ç”¨æ•°ç»„å­˜å‚¨åˆ—è¡¨é¡µåå­—ï¼Œåˆ—è¡¨é¡µç¦»å¼€ç»“åˆ beforeRouteLeave é’©å­åˆ¤æ–­æ˜¯å¦éœ€è¦ç¼“å­˜ï¼Œå¯¹å…¨å±€æ•°ç»„è¿›è¡Œæ›´æ”¹ã€‚

åœ¨ router-view æ ‡ç­¾ä½ç½®å¦‚ä¸‹ä½¿ç”¨

```vue
<template>
  <keep-alive :include="cacheRouting">
    <router-view></router-view>
  </keep-alive>
</template>
<script>
export default {
  computed: {
    cacheRouting() {
      return this.$store.state.cacheRouting
    }
  }
}
</script>
```

åˆ—è¡¨é¡µå¦‚ä¸‹ä½¿ç”¨

```vue
template>
  <div></div>
</template>
<script>
export default {
  beforeRouteLeave(to, from, next) {
    if(to.name === 'è¯¦æƒ…é¡µ') {
      // ... å‘å…¨å±€ç¼“å­˜è·¯ç”±æ•°ç»„æ·»åŠ åˆ—è¡¨é¡µ      
      next()
    } else {
      // ... å‘å…¨å±€ç¼“å­˜è·¯ç”±æ•°ç»„åˆ é™¤åˆ—è¡¨é¡µ     
      next()
    }
  }
}
</script>
```
# keep-alive çš„å®ç°

æ ¸å¿ƒæºç ï¼švue/src/core/components/keep-alive.js

LRUï¼ˆLeast Recently Usedï¼‰ æ›¿æ¢ç­–ç•¥æ ¸å¿ƒæ€æƒ³æ˜¯æ›¿æ¢æœ€è¿‘æœ€å°‘ä½¿ç”¨

```vue
/**
* éå† cache å°†ä¸éœ€è¦çš„ç¼“å­˜çš„ä» cache ä¸­æ¸…é™¤
*/
function pruneCache (keepAliveInstance, filter) {
  const { cache, keys, _vnode } = keepAliveInstance
  for (const key in cache) {
    const cachedNode = cache[key]
    if (cachedNode) {
      const name = getComponentName(cachedNode.componentOptions)
      if (name && !filter(name)) {
        pruneCacheEntry(cache, key, keys, _vnode)
      }
    }
  }
}
/**
* åˆ é™¤ cache ä¸­é”®å€¼ä¸º key çš„è™šæ‹ŸDOM
*/
function pruneCacheEntry (cache, key, keys, current) {
  const entry = cache[key]
  if (entry && (!current || entry.tag !== current.tag)) {
    // æ‰§è¡Œç»„ä»¶çš„ destroy é’©å­
    entry.componentInstance.$destroy()
  }
  // cache ä¸­ç»„ä»¶å¯¹åº”çš„è™šæ‹ŸDOMç½®null
  cache[key] = null
  // åˆ é™¤ç¼“å­˜è™šæ‹ŸDOMçš„ key
  remove(keys, key)
}

export default {
  name: 'keep-alive',
  abstract: true,  

  props: {
    include: patternTypes,
    exclude: patternTypes,
    max: [String, Number]
  },

  created () {
    // ç¼“å­˜è™šæ‹Ÿ DOM
    this.cache = Object.create(null) 
    // ç¼“å­˜è™šæ‹ŸDOMçš„é”®é›†åˆ
    this.keys = [] 
  },

  destroyed () {
    // åˆ é™¤æ‰€æœ‰çš„ç¼“å­˜å†…å®¹
    for (const key in this.cache) {
      pruneCacheEntry(this.cache, key, this.keys)
    }
  },

  mounted () {
    // ç›‘å¬ includeã€exclude å‚æ•°å˜åŒ–ï¼Œè°ƒç”¨ pruneCacheä¿®æ”¹ç¼“å­˜ä¸­çš„ç¼“å­˜æ•°æ®
    this.$watch('include', val => {
      pruneCache(this, name => matches(val, name))
    })
    this.$watch('exclude', val => {
      pruneCache(this, name => !matches(val, name))
    })
  },

  // ç”± render å‡½æ•°å†³å®šæ¸²æŸ“ç»“æœ
  render () {
    const slot = this.$slots.default
    // è·å–ç¬¬ä¸€ä¸ªå­ç»„ä»¶è™šæ‹ŸDOM
    const vnode: VNode = getFirstComponentChild(slot)
    // è·å–è™šæ‹Ÿ DOM çš„é…ç½®å‚æ•°
    const componentOptions: ? VNodeComponentOptions = vnode && vnode.componentOptions
    if (componentOptions) {
      // è·å–ç»„ä»¶åç§°
      const name: ?string = getComponentName(componentOptions)
      const { include, exclude } = this
      // è‹¥ä¸åœ¨includeæˆ–è€…åœ¨excludeä¸­ï¼Œç›´æ¥é€€å‡ºï¼Œä¸èµ°ç¼“å­˜æœºåˆ¶
      if (
        (include && (!name || !matches(include, name))) ||
        (exclude && name && matches(exclude, name))
      ) {
        return vnode
      }

      const { cache, keys } = this
      // è·å–ç»„ä»¶key
      const key: ?string = vnode.key == null
        ? componentOptions.Ctor.cid + (componentOptions.tag ? `::${componentOptions.tag}` : '')
        : vnode.key
      // å‘½ä¸­ç¼“å­˜
      if (cache[key]) {
        // ä» cache ä¸­è·å–ç¼“å­˜çš„å®ä¾‹è®¾ç½®åˆ°å½“å‰çš„ç»„ä»¶ä¸Š
        vnode.componentInstance = cache[key].componentInstance
        // åˆ é™¤åŸæœ‰å­˜åœ¨çš„keyï¼Œå¹¶ç½®äºæœ€å
        remove(keys, key)
        keys.push(key)
      // æœªå‘½ä¸­ç¼“å­˜
      } else {
        // ç¼“å­˜å½“å‰è™šæ‹ŸèŠ‚ç‚¹
        cache[key] = vnode
        // æ·»åŠ å½“å‰ç»„ä»¶key
        keys.push(key)
        // è‹¥ç¼“å­˜ç»„ä»¶è¶…è¿‡maxå€¼ï¼ŒLRU æ›¿æ¢
        if(this.max && keys.length > parseInt(this.max)) {
          pruneCacheEntry(cache, keys[0], keys, this._vnode)
        }
      }
      // è®¾ç½®å½“å‰ç»„ä»¶ keep-alive ä¸º true
      vnode.data.keepAlive = true
    }
    return vnode || (slot && slot[0])
  }
}
```

# Vue-Router é…ç½® 404 é¡µé¢

* ä»£è¡¨é€šé…ç¬¦ï¼Œè‹¥æ”¾åœ¨ä»»æ„è·¯ç”±å‰ï¼Œä¼šè¢«å…ˆåŒ¹é…ï¼Œå¯¼è‡´è·³è½¬åˆ° 404 é¡µé¢ï¼Œæ‰€ä»¥éœ€å°†å¦‚ä¸‹é…ç½®ç½®äºæœ€åã€‚

```
{
  path: '*',
  name: '404'
  component: () => import('./404.vue')  
}
```

# Vue-Router æœ‰å“ªå‡ ç§å¯¼èˆªå®ˆå«

## å…¨å±€å‰ç½®å®ˆå«

åœ¨è·¯ç”±è·³è½¬å‰è§¦å‘ï¼Œå¯åœ¨æ‰§è¡Œ next æ–¹æ³•å‰åšä¸€äº›èº«ä»½ç™»å½•éªŒè¯çš„é€»è¾‘ã€‚

```javascript
const router = new VueRouter({})

router.beforeEach((to, from, next) => {
  ...
  // å¿…é¡»æ‰§è¡Œ next æ–¹æ³•æ¥è§¦å‘è·¯ç”±è·³è½¬ 
  next() 
})
```

## å…¨å±€è§£æå®ˆå«

ä¸ beforeEach ç±»ä¼¼ï¼Œä¹Ÿæ˜¯è·¯ç”±è·³è½¬å‰è§¦å‘ï¼ŒåŒºåˆ«æ˜¯è¿˜éœ€åœ¨æ‰€æœ‰ç»„ä»¶å†…å®ˆå«å’Œå¼‚æ­¥è·¯ç”±ç»„ä»¶è¢«è§£æä¹‹åï¼Œä¹Ÿå°±æ˜¯åœ¨ç»„ä»¶å†… beforeRouteEnter ä¹‹åè¢«è°ƒç”¨ã€‚

```javascript
const router = new VueRouter({})

router.beforeResolve((to, from, next) => {
  ...
  // å¿…é¡»æ‰§è¡Œ next æ–¹æ³•æ¥è§¦å‘è·¯ç”±è·³è½¬ 
  next() 
})
```

## å…¨å±€åç½®é’©å­

å’Œå®ˆå«ä¸åŒçš„æ˜¯ï¼Œè¿™äº›é’©å­ä¸ä¼šæ¥å— next å‡½æ•°ä¹Ÿä¸ä¼šæ”¹å˜å¯¼èˆªæœ¬èº«ã€‚

```javascript
router.afterEach((to, from) => {
  // ...
})

```

## è·¯ç”±ç‹¬äº«å®ˆå«

å¯åœ¨è·¯ç”±é…ç½®ä¸Šç›´æ¥å®šä¹‰ beforeEnter

```javascript

const router = new VueRouter({
  routes: [
    {
      path: '/home',
      component: Home,
      beforeEnter: (to, from, next) => {
      
      }
    }
  ]
})
```

## ç»„ä»¶å†…çš„å®ˆå«

ç»„ä»¶å†…å¯ç›´æ¥å®šä¹‰å¦‚ä¸‹è·¯ç”±å¯¼èˆªå®ˆå«

```javascript
const Foo = {
  template: `...`,
  beforeRouteEnter(to, from, next) {
    // ä¸èƒ½è·å–ç»„ä»¶å®ä¾‹ this
    // å½“å®ˆå«æ‰§è¡Œå‰ï¼Œç»„ä»¶å®ä¾‹è¿˜æ²¡è¢«åˆ›å»º
  },
  beforeRouteUpdate(to, from, next) {
    // å½“å‰è·¯ç”±æ”¹å˜ï¼Œä½†æ˜¯ç»„ä»¶è¢«å¤ç”¨æ—¶è°ƒç”¨
    // å¯è®¿é—®å®ä¾‹ this
  },
  beforeRouteLeave(to, from, next) {
    // å¯¼èˆªç¦»å¼€ç»„ä»¶æ—¶è¢«è°ƒç”¨
  }
}
```

# Vue-Router å®Œæ•´çš„å¯¼èˆªè§£ææµç¨‹

1.å¯¼èˆªè¢«è§¦å‘
2.åœ¨å¤±æ´»çš„ç»„ä»¶é‡Œè°ƒç”¨ beforeRouteLeave å®ˆå«
3.è°ƒç”¨å…¨å±€ beforeEach å‰ç½®å®ˆå«
4.é‡ç”¨çš„ç»„ä»¶è°ƒç”¨ beforeRouteUpdate å®ˆå«ï¼ˆ2.2+ï¼‰
5.è·¯ç”±é…ç½®è°ƒç”¨ beforeEnter
6.è§£æå¼‚æ­¥è·¯ç”±ç»„ä»¶
7.åœ¨è¢«æ¿€æ´»çš„ç»„ä»¶é‡Œè°ƒç”¨ beforeRouteEnter å®ˆå«
8.è°ƒç”¨å…¨å±€çš„ beforeResolve å®ˆå«ï¼ˆ2.5+ï¼‰
9.å¯¼èˆªè¢«ç¡®è®¤
10.è°ƒç”¨å…¨å±€çš„ afterEach
11.è§¦å‘ DOM æ›´æ–°
12.è°ƒç”¨  beforeRouteEnter å®ˆå«ä¸­ä¼ ç»™ next çš„å›è°ƒå‡½æ•°ï¼Œåˆ›å»ºå¥½çš„ç»„ä»¶å®ä¾‹ä¼šä½œä¸ºå›è°ƒå‡½æ•°çš„å‚æ•°ä¼ å…¥

















